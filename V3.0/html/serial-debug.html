<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>串口调试平台 - 实时数据监控</title>
    <!-- 本地资源优先 -->
    <!-- 图标库 - 本地优先 -->
    <link rel="stylesheet" href="libs/css/fontawesome/all.min.css" onerror="this.onerror=null;this.href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css';">
    <link rel="stylesheet" href="libs/css/fontawesome/fallback.css">
    <!-- 备用CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" media="none" onload="if(media!='all')media='all'" crossorigin="anonymous" referrerpolicy="no-referrer">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"></noscript>
    
    <!-- Google字体 - 本地备份 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="libs/fonts/inter/inter.css" rel="stylesheet" onerror="this.onerror=null;this.href='https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap';">
    
    <!-- 串口调试专用库加载器 -->
    <script>
        // 串口调试页面库配置
        const serialLibs = [
            {
                name: 'Chart.js',
                local: 'libs/js/chart/chart.min.js',
                cdn: ['https://cdn.jsdelivr.net/npm/chart.js']
            },
            {
                name: 'Chart.js Zoom Plugin',
                local: 'libs/js/chart/chartjs-plugin-zoom.min.js',
                cdn: ['https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js']
            },
            {
                name: 'SheetJS',
                local: 'libs/js/xlsx/xlsx.full.min.js',
                cdn: ['https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js']
            }
        ];

        async function loadSerialLibraries() {
            console.log('开始按顺序加载串口调试所需库...');
            
            let successCount = 0;
            let totalLibs = serialLibs.length;
            let hasTimeout = false;
            
            // 设置总体超时（30秒）
            const timeoutId = setTimeout(() => {
                hasTimeout = true;
                hideLoadingStatus();
                console.error('❌ 库加载总体超时');
                alert('页面加载超时。\n\n可能的解决方案：\n1. 刷新页面重试\n2. 检查网络连接\n3. 清除浏览器缓存');
            }, 30000);
            
            // 按顺序加载以确保依赖关系
            for (const lib of serialLibs) {
                if (hasTimeout) break;
                
                // 只在控制台显示加载进度，不显示通知
                console.log(`正在加载 ${lib.name}...`);
                
                try {
                    await loadScript(lib.local, 6000); // 6秒超时
                    console.log(`✓ ${lib.name} 本地加载成功`);
                    
                    // 对于Chart.js，验证是否正确加载
                    if (lib.name === 'Chart.js' && typeof Chart === 'undefined') {
                        throw new Error('Chart.js未正确加载');
                    }
                    
                    successCount++;
                } catch (error) {
                    if (hasTimeout) break;
                    
                    console.warn(`本地加载失败: ${lib.name}，尝试CDN...`);
                    
                    let loaded = false;
                    for (const cdnUrl of lib.cdn) {
                        if (hasTimeout) break;
                        
                        try {
                            await loadScript(cdnUrl, 6000); // 6秒超时
                            console.log(`✓ ${lib.name} CDN加载成功`);
                            
                            // 对于Chart.js，验证是否正确加载
                            if (lib.name === 'Chart.js' && typeof Chart === 'undefined') {
                                throw new Error('Chart.js CDN未正确加载');
                            }
                            
                            loaded = true;
                            successCount++;
                            break;
                        } catch (cdnError) {
                            console.warn(`✗ ${lib.name} CDN加载失败: ${cdnUrl}`);
                        }
                    }
                    
                    if (!loaded && !hasTimeout) {
                        console.error(`✗ ${lib.name} 所有源都加载失败`);
                        if (lib.name === 'Chart.js') {
                            clearTimeout(timeoutId);
                            console.error('Chart.js加载失败，启用兼容模式...');
                            setTimeout(() => {
                                hideLoadingStatus();
                                alert('图表组件加载失败。\n\n页面将以兼容模式运行，部分功能可能受限。\n\n建议：刷新页面重试或检查网络连接。');
                            }, 2000);
                            return;
                        }
                    }
                }
                
                // 每个库加载后稍作等待，确保完全初始化
                if (!hasTimeout) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            if (hasTimeout) return;
            
            clearTimeout(timeoutId);
            console.log('验证组件完整性...');
            
            // 验证关键对象是否可用
            await new Promise(resolve => setTimeout(resolve, 500));
            
            let allReady = true;
            if (typeof Chart === 'undefined') {
                console.error('❌ Chart.js 验证失败');
                allReady = false;
            } else {
                console.log('✓ Chart.js 验证通过');
            }
            
            if (typeof XLSX === 'undefined') {
                console.warn('⚠️  XLSX 验证失败');
            } else {
                console.log('✓ XLSX 验证通过');
            }
            
            if (allReady) {
                console.log('✅ 加载完成！正在初始化...');
                setTimeout(() => {
                    hideLoadingStatus();
                    console.log(`✅ 串口调试库加载完成 (${successCount}/${totalLibs})`);
                    librariesLoaded = true;
                    checkReadyAndInitialize();
                }, 500);
            } else {
                console.log('⚠️ 部分组件加载失败');
                setTimeout(() => {
                    hideLoadingStatus();
                    console.log(`⚠️ 串口调试库部分加载完成 (${successCount}/${totalLibs})`);
                    librariesLoaded = true; // 即使部分失败也允许初始化
                    checkReadyAndInitialize();
                }, 1000);
            }
        }

        function loadScript(src, timeout = 10000) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.async = true; // 异步加载
                
                // 设置超时
                const timeoutId = setTimeout(() => {
                    script.remove();
                    reject(new Error(`Script load timeout: ${src}`));
                }, timeout);
                
                script.onload = () => {
                    clearTimeout(timeoutId);
                    resolve();
                };
                
                script.onerror = () => {
                    clearTimeout(timeoutId);
                    script.remove();
                    reject(new Error(`Script load failed: ${src}`));
                };
                
                document.head.appendChild(script);
            });
        }

        // 显示加载状态
        function showLoadingStatus(message) {
            let loader = document.getElementById('loading-status');
            if (!loader) {
                loader = document.createElement('div');
                loader.id = 'loading-status';
                loader.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: rgba(59, 130, 246, 0.95); color: white; padding: 20px 30px;
                    border-radius: 12px; z-index: 10000; font-size: 16px; text-align: center;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3); backdrop-filter: blur(10px);
                `;
                document.body.appendChild(loader);
            }
            loader.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); 
                                border-top: 3px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <span>${message}</span>
                </div>
                <style>
                    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                </style>
            `;
        }
        
        function hideLoadingStatus() {
            const loader = document.getElementById('loading-status');
            if (loader) {
                loader.remove();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 只在控制台记录，不显示通知
            console.log('正在加载串口调试组件...');
            loadSerialLibraries().catch(error => {
                console.error('库加载失败:', error);
                librariesLoaded = true; // 即使失败也允许尝试初始化
                checkReadyAndInitialize();
            });
            domReady = true;
        });
    </script>
    
    <style>
        /* 重置样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: auto;
            overflow-y: auto;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background:
                radial-gradient(circle at 20% 80%, rgba(147, 197, 253, 0.3) 0%, transparent 60%),
                radial-gradient(circle at 80% 20%, rgba(196, 181, 253, 0.25) 0%, transparent 60%),
                radial-gradient(circle at 40% 40%, rgba(167, 243, 208, 0.2) 0%, transparent 60%),
                radial-gradient(circle at 60% 80%, rgba(254, 202, 202, 0.2) 0%, transparent 60%),
                radial-gradient(circle at 90% 60%, rgba(253, 230, 138, 0.15) 0%, transparent 60%),
                linear-gradient(135deg, #f8fafc 0%, #f1f5f9 20%, #e2e8f0 40%, #f0f9ff 60%, #fce7f3 80%, #fce7f3 100%);
            background-size: 100% 100%, 100% 100%, 100% 100%, 100% 100%, 100% 100%, 100% 100%;
            background-attachment: fixed;
            min-height: 100vh;
            color: #1e293b;
            overflow-x: auto;
            overflow-y: auto;
            position: relative;
            animation: backgroundShift 30s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0%, 100% {
                background-position: 0% 0%, 100% 100%, 50% 50%, 25% 75%, 90% 60%, 0% 0%;
            }
            16% {
                background-position: 10% 20%, 90% 80%, 30% 70%, 45% 55%, 80% 40%, 16% 16%;
            }
            33% {
                background-position: 30% 40%, 70% 60%, 60% 30%, 65% 35%, 70% 80%, 33% 33%;
            }
            50% {
                background-position: 60% 80%, 40% 20%, 80% 60%, 25% 75%, 60% 20%, 50% 50%;
            }
            66% {
                background-position: 80% 60%, 20% 40%, 40% 80%, 75% 25%, 50% 60%, 66% 66%;
            }
            83% {
                background-position: 40% 20%, 60% 80%, 20% 40%, 55% 65%, 40% 80%, 83% 83%;
            }
        }

        /* 增强动态背景元素 */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .animated-shape {
            position: absolute;
            border-radius: 50%;
            animation: float 25s ease-in-out infinite;
        }

        .shape1 {
            width: 400px;
            height: 400px;
            top: 5%;
            left: 5%;
            background: radial-gradient(circle, rgba(147, 197, 253, 0.4) 0%, rgba(191, 219, 254, 0.15) 100%);
            animation-delay: 0s;
        }

        .shape2 {
            width: 300px;
            height: 300px;
            top: 50%;
            right: 5%;
            background: radial-gradient(circle, rgba(196, 181, 253, 0.35) 0%, rgba(221, 214, 254, 0.15) 100%);
            animation-delay: 8s;
        }

        .shape3 {
            width: 250px;
            height: 250px;
            bottom: 10%;
            left: 15%;
            background: radial-gradient(circle, rgba(167, 243, 208, 0.4) 0%, rgba(209, 250, 229, 0.15) 100%);
            animation-delay: 16s;
        }

        .shape4 {
            width: 350px;
            height: 350px;
            top: 25%;
            right: 25%;
            background: radial-gradient(circle, rgba(254, 202, 202, 0.35) 0%, rgba(254, 226, 226, 0.15) 100%);
            animation-delay: 12s;
        }

        .shape5 {
            width: 200px;
            height: 200px;
            top: 70%;
            left: 60%;
            background: radial-gradient(circle, rgba(253, 230, 138, 0.4) 0%, rgba(254, 240, 138, 0.15) 100%);
            animation-delay: 4s;
        }

        .shape6 {
            width: 180px;
            height: 180px;
            top: 15%;
            left: 70%;
            background: radial-gradient(circle, rgba(252, 231, 243, 0.35) 0%, rgba(253, 242, 248, 0.15) 100%);
            animation-delay: 20s;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px) translateX(0px) rotate(0deg) scale(1);
                opacity: 0.4;
            }
            25% {
                transform: translateY(-30px) translateX(20px) rotate(90deg) scale(1.1);
                opacity: 0.2;
            }
            50% {
                transform: translateY(-60px) translateX(-10px) rotate(180deg) scale(0.9);
                opacity: 0.6;
            }
            75% {
                transform: translateY(-20px) translateX(-30px) rotate(270deg) scale(1.05);
                opacity: 0.3;
            }
        }

        /* 粒子效果 */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: particleFloat 15s linear infinite;
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(100vh) translateX(0px);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(100px);
                opacity: 0;
            }
        }

        /* 光效 */
        .light-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .light-beam {
            position: absolute;
            width: 2px;
            height: 100%;
            background: linear-gradient(to bottom,
                transparent 0%,
                rgba(255, 255, 255, 0.1) 50%,
                transparent 100%);
            animation: lightSweep 12s ease-in-out infinite;
        }

        .light-beam:nth-child(1) { left: 10%; animation-delay: 0s; }
        .light-beam:nth-child(2) { left: 30%; animation-delay: 4s; }
        .light-beam:nth-child(3) { left: 60%; animation-delay: 8s; }
        .light-beam:nth-child(4) { left: 85%; animation-delay: 2s; }

        @keyframes lightSweep {
            0%, 100% {
                opacity: 0;
                transform: scaleY(0);
            }
            50% {
                opacity: 1;
                transform: scaleY(1);
            }
        }

        /* 页面加载动画 */
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 25%, #bae6fd 50%, #7dd3fc 75%, #38bdf8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.6s ease, visibility 0.6s ease;
        }

        .page-loader.loaded {
            opacity: 0;
            visibility: hidden;
        }

        .loader-content {
            text-align: center;
            color: #0369a1;
        }

        .spinner {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 25px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .spinner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: #0369a1;
            animation: spin 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }

        .spinner-ring:nth-child(1) {
            animation-delay: 0s;
        }

        .spinner-ring:nth-child(2) {
            width: 80%;
            height: 80%;
            border-top-color: #0284c7;
            animation-delay: 0.15s;
            animation-direction: reverse;
        }

        .spinner-ring:nth-child(3) {
            width: 60%;
            height: 60%;
            border-top-color: #0ea5e9;
            animation-delay: 0.3s;
        }

        .spinner-dot {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #0369a1;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(3, 105, 161, 0.5);
            animation: spinnerDot 1.5s ease-in-out infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes spinnerDot {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .loading-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(3, 105, 161, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin: 0 auto;
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #0369a1, #0ea5e9);
            border-radius: 2px;
            animation: loadingProgress 2s ease-in-out infinite;
        }

        @keyframes loadingProgress {
            0% {
                width: 0%;
                transform: translateX(-100%);
            }
            50% {
                width: 100%;
                transform: translateX(0%);
            }
            100% {
                width: 100%;
                transform: translateX(100%);
            }
        }

        /* 主容器布局 */
        .main-container {
            display: grid;
            grid-template-columns: 260px 1fr;
            min-height: 100vh;
            height: auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            min-width: 1400px;
            overflow-x: hidden;
        }

        /* 左侧导航栏 */
        .sidebar {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(25px);
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow:
                4px 0 25px rgba(0, 0, 0, 0.06),
                2px 0 15px rgba(59, 130, 246, 0.08);
            overflow-y: auto;
            position: relative;
            padding: 15px 12px;
        }

        .sidebar-header {
            padding: 20px 15px;
            text-align: center;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(14, 165, 233, 0.1) 100%);
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #3b82f6, #0ea5e9);
            border-radius: 16px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .sidebar-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
            background: linear-gradient(135deg, #3b82f6, #0ea5e9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* 导航菜单 */
        .nav-section {
            padding: 25px 20px;
        }

        .nav-category {
            margin-bottom: 25px;
        }

        .category-header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(14, 165, 233, 0.1) 100%);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .category-header:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(14, 165, 233, 0.15) 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
        }

        .category-icon {
            font-size: 18px;
            color: #3b82f6;
            margin-right: 12px;
            width: 20px;
        }

        .category-title {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }

        .category-arrow {
            font-size: 12px;
            color: #3b82f6;
            transition: transform 0.3s ease;
        }

        .category-header.expanded .category-arrow {
            transform: rotate(180deg);
        }

        .nav-submenu {
            list-style: none;
            margin-top: 10px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .nav-category.expanded .nav-submenu {
            max-height: 300px;
        }

        .nav-item {
            margin: 5px 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px 12px 45px;
            color: #64748b;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 0;
            height: 100%;
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), transparent);
            border-radius: 8px;
            transition: width 0.3s ease;
        }

        .nav-link:hover::before {
            width: 100%;
        }

        .nav-link:hover {
            color: #3b82f6;
            transform: translateX(8px);
        }

        .nav-icon {
            font-size: 16px;
            margin-right: 10px;
            width: 18px;
            color: #94a3b8;
            transition: color 0.3s ease;
        }

        .nav-link:hover .nav-icon {
            color: #3b82f6;
        }

        .nav-link.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(14, 165, 233, 0.15) 100%);
            color: #3b82f6;
            border-left: 4px solid #3b82f6;
            transform: translateX(8px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
        }

        .nav-link.active .nav-icon {
            color: #3b82f6;
        }

        .nav-link.active::before {
            width: 100%;
        }

        .nav-text {
            font-size: 14px;
            font-weight: 500;
        }

        /* 意见反馈样式 */
        .feedback-section {
            position: absolute;
            bottom: 20px;
            left: 12px;
            right: 12px;
            padding: 15px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(14, 165, 233, 0.1) 100%);
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .feedback-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 20px;
            color: #3b82f6;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .feedback-link:hover {
            background: linear-gradient(135deg, #3b82f6, #0ea5e9);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .feedback-icon {
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .feedback-link:hover .feedback-icon {
            transform: scale(1.1);
        }

        .feedback-text {
            font-size: 14px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- 页面加载动画 -->
    <div class="page-loader" id="pageLoader">
        <div class="loader-content">
            <div class="spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-dot"></div>
            </div>
            <div class="loading-text">正在加载串口调试平台...</div>
            <div class="loading-progress">
                <div class="loading-bar"></div>
            </div>
        </div>
    </div>

    <!-- 增强动态背景元素 -->
    <div class="animated-bg">
        <div class="animated-shape shape1"></div>
        <div class="animated-shape shape2"></div>
        <div class="animated-shape shape3"></div>
        <div class="animated-shape shape4"></div>
        <div class="animated-shape shape5"></div>
        <div class="animated-shape shape6"></div>
    </div>

    <!-- 粒子效果 -->
    <div class="particles" id="particles"></div>

    <!-- 光效 -->
    <div class="light-effects">
        <div class="light-beam"></div>
        <div class="light-beam"></div>
        <div class="light-beam"></div>
        <div class="light-beam"></div>
    </div>

    <!-- 主容器 -->
    <div class="main-container">
        <!-- 左侧导航栏 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-terminal"></i>
                </div>
                <h1 class="sidebar-title">串口调试平台</h1>
            </div>

            <nav class="nav-section">
                <!-- 信号可视化分类 -->
                <div class="nav-category expanded">
                    <div class="category-header expanded" data-category="signal-visualization">
                        <i class="fas fa-chart-line category-icon"></i>
                        <span class="category-title">信号可视化</span>
                        <i class="fas fa-chevron-down category-arrow"></i>
                    </div>
                    <ul class="nav-submenu">
                        <li class="nav-item">
                            <a href="data.html" class="nav-link" data-page="data">
                                <i class="fas fa-upload nav-icon"></i>
                                <span class="nav-text">数据上传</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="serial-debug.html" class="nav-link active" data-page="serial-debug">
                                <i class="fas fa-terminal nav-icon"></i>
                                <span class="nav-text">串口调试</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- 云平台管理分类 -->
                <div class="nav-category">
                    <div class="category-header" data-category="cloud-platform">
                        <i class="fas fa-cloud category-icon"></i>
                        <span class="category-title">云平台管理</span>
                        <i class="fas fa-chevron-down category-arrow"></i>
                    </div>
                    <ul class="nav-submenu">
                        <li class="nav-item">
                            <a href="cloud-dashboard.html" class="nav-link" data-page="cloud-dashboard">
                                <i class="fas fa-tachometer-alt nav-icon"></i>
                                <span class="nav-text">云平台看板</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="exbug-tool.html" class="nav-link" data-page="exbug-tool">
                                <i class="fas fa-tools nav-icon"></i>
                                <span class="nav-text">ExDebug Tool</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- 意见反馈 - 底部固定位置 -->
            <div class="feedback-section">
                <a href="feedback.html" class="feedback-link">
                    <i class="fas fa-comment-dots feedback-icon"></i>
                    <span class="feedback-text">意见反馈</span>
                </a>
            </div>
        </aside>

        <!-- 主内容区域 -->
        <main class="main-content">
            <style>
                /* 主内容区域样式 */
                .main-content {
                    padding: 15px 20px 15px 20px;
                    background: rgba(255, 255, 255, 0.02);
                    min-height: 100vh;
                    box-sizing: border-box;
                    display: flex;
                    flex-direction: column;
                    overflow-x: hidden;
                    overflow-y: auto;
                }

                /* 内容布局 */
                .content-layout {
                    display: grid;
                    grid-template-columns: 300px 1fr;
                    gap: 20px;
                    min-width: 1200px;
                    max-width: 100%;
                    width: 100%;
                    align-items: stretch;
                    padding: 15px;
                    padding-bottom: 15px;
                    flex: 1;
                    min-height: 0;
                    box-sizing: border-box;
                }

                /* 左侧控制面板 */
                .control-panel {
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                    overflow-y: auto;
                    overflow-x: hidden;
                    padding-bottom: 10px;
                    padding-right: 5px;
                    /* 高度将通过JavaScript动态设置 */
                    flex-shrink: 0;
                    min-height: 0;
                    max-width: 300px;
                    width: 300px;
                }

                .control-card {
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(25px);
                    border-radius: 16px;
                    padding: 16px;
                    box-shadow:
                        0 10px 40px rgba(0, 0, 0, 0.06),
                        0 4px 20px rgba(59, 130, 246, 0.08),
                        inset 0 1px 0 rgba(255, 255, 255, 0.8);
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    transition: all 0.3s ease;
                    position: relative;
                    overflow: hidden;
                    flex-shrink: 0;
                    width: 100%;
                    max-width: 100%;
                    box-sizing: border-box;
                }

                .control-card:first-child {
                    flex: 0 0 auto;
                    margin-bottom: 0;
                }

                .control-card.serial-connection-card {
                    flex: 0 0 auto;
                    min-height: auto;
                    height: fit-content;
                }

                /* 统计分析卡片特定样式 */
                .control-card:last-child {
                    height: fit-content;
                    min-height: auto;
                    max-height: fit-content;
                    overflow: visible;
                    padding-bottom: 20px !important;
                    background: rgba(255, 255, 255, 0.95) !important;
                    backdrop-filter: blur(25px) !important;
                }

                .control-card::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    height: 1px;
                    background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent);
                }

                .control-card:hover {
                    box-shadow:
                        0 15px 50px rgba(0, 0, 0, 0.1),
                        0 6px 25px rgba(59, 130, 246, 0.12),
                        inset 0 1px 0 rgba(255, 255, 255, 0.9);
                    border-color: rgba(255, 255, 255, 0.5);
                }

                .control-card:active {
                    transition: all 0.1s ease;
                }

                .control-card h3 {
                    font-size: 18px;
                    font-weight: 600;
                    color: #1e293b;
                    margin-bottom: 20px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }

                .control-card h3 i {
                    color: #3b82f6;
                    font-size: 20px;
                }

                /* 串口连接卡片 */
                .serial-connection-card {
                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(14, 165, 233, 0.1) 100%);
                    border: 1px solid rgba(59, 130, 246, 0.2);
                }

                .connection-status {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                    padding: 12px;
                    background: rgba(255, 255, 255, 0.8);
                    border-radius: 10px;
                    margin-bottom: 15px;
                    border: 2px solid rgba(59, 130, 246, 0.2);
                    transition: all 0.3s ease;
                }

                .connection-status.connected {
                    border-color: rgba(34, 197, 94, 0.4);
                    background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
                }

                .connection-status.disconnected {
                    border-color: rgba(239, 68, 68, 0.4);
                    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
                }

                .status-indicator {
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    background: #94a3b8;
                    animation: pulse 2s infinite;
                }

                .status-indicator.connected {
                    background: #22c55e;
                }

                .status-indicator.disconnected {
                    background: #ef4444;
                }

                @keyframes pulse {
                    0%, 100% {
                        opacity: 1;
                        transform: scale(1);
                    }
                    50% {
                        opacity: 0.7;
                        transform: scale(1.1);
                    }
                }

                .status-text {
                    font-size: 14px;
                    font-weight: 600;
                    color: #1e293b;
                }

                /* 连接类型选择器样式 */
                .connection-type-selector {
                    margin-bottom: 12px;
                }

                .connection-type-selector label {
                    display: block;
                    font-size: 12px;
                    font-weight: 500;
                    color: #64748b;
                    margin-bottom: 8px;
                }

                .connection-tabs {
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 6px;
                }

                .conn-tab {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    gap: 3px;
                    padding: 8px 4px;
                    border: 2px solid rgba(59, 130, 246, 0.2);
                    border-radius: 8px;
                    background: rgba(255, 255, 255, 0.8);
                    cursor: pointer;
                    transition: all 0.3s ease;
                    font-size: 10px;
                    color: #64748b;
                    min-width: 0;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                }

                .conn-tab i {
                    font-size: 16px;
                    color: #94a3b8;
                    transition: color 0.3s ease;
                }

                .conn-tab:hover {
                    border-color: rgba(59, 130, 246, 0.5);
                    background: rgba(59, 130, 246, 0.05);
                }

                .conn-tab:hover i {
                    color: #3b82f6;
                }

                .conn-tab.active {
                    border-color: #3b82f6;
                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(14, 165, 233, 0.1) 100%);
                    color: #3b82f6;
                }

                .conn-tab.active i {
                    color: #3b82f6;
                }

                .connection-config {
                    animation: fadeIn 0.3s ease;
                }

                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(-10px); }
                    to { opacity: 1; transform: translateY(0); }
                }

                /* TCP历史连接 */
                .tcp-history {
                    margin-top: 12px;
                }

                .tcp-history label {
                    display: block;
                    font-size: 11px;
                    font-weight: 500;
                    color: #64748b;
                    margin-bottom: 6px;
                }

                .history-list {
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                    max-height: 80px;
                    overflow-y: auto;
                }

                .history-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 6px 10px;
                    background: rgba(59, 130, 246, 0.05);
                    border-radius: 6px;
                    font-size: 11px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                }

                .history-item:hover {
                    background: rgba(59, 130, 246, 0.1);
                }

                .history-item button {
                    background: none;
                    border: none;
                    color: #94a3b8;
                    cursor: pointer;
                    padding: 2px 4px;
                    font-size: 10px;
                }

                .history-item button:hover {
                    color: #ef4444;
                }

                /* 蓝牙信息提示 */
                .bluetooth-info {
                    margin-top: 12px;
                    padding: 8px;
                    background: rgba(59, 130, 246, 0.05);
                    border-radius: 6px;
                    font-size: 11px;
                    color: #64748b;
                }

                .bluetooth-info i {
                    color: #3b82f6;
                    margin-right: 4px;
                }

                /* 串口配置样式 */
                .serial-config {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                    margin-bottom: 15px;
                }

                .config-group {
                    display: flex;
                    flex-direction: column;
                    gap: 6px;
                    min-width: 0;
                }

                .config-group input[type="text"],
                .config-group input[type="number"] {
                    padding: 8px 10px;
                    border: 2px solid rgba(59, 130, 246, 0.2);
                    border-radius: 8px;
                    font-size: 12px;
                    transition: all 0.3s ease;
                    background: rgba(255, 255, 255, 0.8);
                    width: 100%;
                    box-sizing: border-box;
                }

                .config-group input[type="text"]:focus,
                .config-group input[type="number"]:focus {
                    outline: none;
                    border-color: #3b82f6;
                    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                }

                .config-group label {
                    font-size: 11px;
                    font-weight: 500;
                    color: #64748b;
                }

                .custom-select {
                    position: relative;
                    display: block;
                    width: 100%;
                }

                .custom-select select {
                    width: 100%;
                    padding: 10px 35px 10px 12px;
                    border: 2px solid transparent;
                    border-radius: 10px;
                    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
                    backdrop-filter: blur(20px);
                    color: #1e293b;
                    font-size: 12px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    appearance: none;
                    -webkit-appearance: none;
                    -moz-appearance: none;
                    box-shadow:
                        0 4px 15px rgba(0, 0, 0, 0.08),
                        0 2px 8px rgba(59, 130, 246, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.8);
                    box-sizing: border-box;
                }

                .custom-select select:hover {
                    border-color: rgba(59, 130, 246, 0.3);
                    box-shadow:
                        0 6px 25px rgba(0, 0, 0, 0.12),
                        0 4px 15px rgba(59, 130, 246, 0.15),
                        inset 0 1px 0 rgba(255, 255, 255, 0.9);
                    transform: translateY(-1px);
                }

                .custom-select select:focus {
                    outline: none;
                    border-color: #3b82f6;
                    box-shadow:
                        0 8px 30px rgba(0, 0, 0, 0.15),
                        0 4px 20px rgba(59, 130, 246, 0.25),
                        0 0 0 4px rgba(59, 130, 246, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 1);
                    transform: translateY(-2px);
                }

                .custom-select::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(14, 165, 233, 0.05) 100%);
                    border-radius: 12px;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                    pointer-events: none;
                    z-index: 1;
                }

                .custom-select:hover::before {
                    opacity: 1;
                }

                .custom-select::after {
                    content: '\f107';
                    font-family: 'Font Awesome 6 Free';
                    font-weight: 900;
                    position: absolute;
                    top: 50%;
                    right: 16px;
                    transform: translateY(-50%);
                    color: #3b82f6;
                    font-size: 16px;
                    pointer-events: none;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    z-index: 2;
                }

                .custom-select:hover::after {
                    transform: translateY(-50%) scale(1.1) rotate(180deg);
                    color: #2563eb;
                }

                /* 选项样式 */
                .custom-select select option {
                    padding: 12px 16px;
                    background: rgba(255, 255, 255, 0.95);
                    color: #1e293b;
                    font-weight: 500;
                    border: none;
                }

                .custom-select select option:hover {
                    background: rgba(59, 130, 246, 0.1);
                }

                .custom-select select option:checked {
                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(14, 165, 233, 0.15) 100%);
                    color: #1d4ed8;
                    font-weight: 600;
                }

                /* 连接按钮样式 */
                .connection-buttons {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                    margin-bottom: 15px;
                }

                .btn {
                    padding: 10px 16px;
                    border: none;
                    border-radius: 8px;
                    font-size: 13px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    gap: 6px;
                    text-decoration: none;
                }

                .btn-connect {
                    background: linear-gradient(135deg, #22c55e, #16a34a);
                    color: white;
                    box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
                }

                .btn-connect:hover {
                    transform: translateY(-3px) scale(1.05);
                    box-shadow: 0 12px 35px rgba(34, 197, 94, 0.5);
                    background: linear-gradient(135deg, #16a34a, #15803d);
                }

                .btn-disconnect {
                    background: linear-gradient(135deg, #ef4444, #dc2626);
                    color: white;
                    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
                }

                .btn-disconnect:hover {
                    transform: translateY(-3px) scale(1.05);
                    box-shadow: 0 12px 35px rgba(239, 68, 68, 0.5);
                    background: linear-gradient(135deg, #dc2626, #b91c1c);
                }

                .btn:disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                    transform: none !important;
                    box-shadow: none !important;
                }

                /* 监视器状态样式 */
                .monitor-status {
                    margin-left: auto;
                }

                .status-badge {
                    padding: 4px 8px;
                    border-radius: 12px;
                    font-size: 10px;
                    font-weight: 600;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }

                .status-badge.receiving {
                    background: linear-gradient(135deg, #22c55e, #16a34a);
                    color: white;
                    animation: pulse 2s infinite;
                }

                .status-badge.paused {
                    background: linear-gradient(135deg, #f59e0b, #d97706);
                    color: white;
                }

                .status-badge.no-data {
                    background: linear-gradient(135deg, #94a3b8, #64748b);
                    color: white;
                }

                /* 监视器容器样式 */
                .monitor-container {
                    border: 2px solid rgba(59, 130, 246, 0.2);
                    border-radius: 12px;
                    overflow: hidden;
                    background: rgba(255, 255, 255, 0.9);
                }

                .monitor-header {
                    padding: 10px 15px;
                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(14, 165, 233, 0.1) 100%);
                    border-bottom: 1px solid rgba(59, 130, 246, 0.2);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                .monitor-controls {
                    display: flex;
                    gap: 8px;
                }

                .btn-small {
                    padding: 6px 12px;
                    font-size: 11px;
                    border-radius: 6px;
                    border: none;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    gap: 4px;
                }

                .btn-clear {
                    background: linear-gradient(135deg, #ef4444, #dc2626);
                    color: white;
                }

                .btn-pause {
                    background: linear-gradient(135deg, #f59e0b, #d97706);
                    color: white;
                }

                .btn-small:hover {
                    transform: translateY(-2px) scale(1.05);
                }

                .monitor-display {
                    height: 150px;
                    padding: 15px;
                    overflow-y: auto;
                    font-family: 'Courier New', monospace;
                    font-size: 11px;
                    line-height: 1.4;
                    background: #1e293b;
                    color: #e2e8f0;
                }

                .monitor-placeholder {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    height: 100%;
                    color: #64748b;
                    text-align: center;
                }

                .monitor-placeholder i {
                    font-size: 24px;
                    margin-bottom: 10px;
                    color: #3b82f6;
                }

                .monitor-line {
                    margin-bottom: 2px;
                    padding: 2px 0;
                    border-left: 3px solid transparent;
                    padding-left: 8px;
                }

                .monitor-line.received {
                    border-left-color: #22c55e;
                    color: #86efac;
                }

                .monitor-line.sent {
                    border-left-color: #3b82f6;
                    color: #93c5fd;
                }

                .monitor-line.error {
                    border-left-color: #ef4444;
                    color: #fca5a5;
                }

                /* 发送容器样式 */
                .send-container {
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                }

                .send-input-group {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }

                .send-input-group label {
                    font-size: 12px;
                    font-weight: 500;
                    color: #64748b;
                }

                .send-input-group textarea {
                    width: 100%;
                    padding: 10px;
                    border: 2px solid rgba(59, 130, 246, 0.2);
                    border-radius: 8px;
                    background: rgba(255, 255, 255, 0.9);
                    color: #1e293b;
                    font-size: 12px;
                    font-family: 'Courier New', monospace;
                    resize: vertical;
                    transition: all 0.3s ease;
                }

                .send-input-group textarea:focus {
                    outline: none;
                    border-color: #3b82f6;
                    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                }

                .send-options {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 12px;
                }

                .send-format, .send-interval {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }

                .send-interval input {
                    width: 100%;
                    padding: 10px;
                    border: 2px solid rgba(59, 130, 246, 0.2);
                    border-radius: 8px;
                    background: rgba(255, 255, 255, 0.9);
                    color: #1e293b;
                    font-size: 12px;
                    transition: all 0.3s ease;
                }

                .send-interval input:focus {
                    outline: none;
                    border-color: #3b82f6;
                    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                }

                .send-buttons {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 12px;
                }

                .btn-primary {
                    background: linear-gradient(135deg, #3b82f6, #0ea5e9);
                    color: white;
                    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
                }

                .btn-primary:hover {
                    transform: translateY(-3px) scale(1.05);
                    box-shadow: 0 12px 35px rgba(59, 130, 246, 0.5);
                    background: linear-gradient(135deg, #2563eb, #0284c7);
                }

                .btn-outline {
                    background: transparent;
                    color: #3b82f6;
                    border: 2px solid #3b82f6;
                    position: relative;
                    overflow: hidden;
                }

                .btn-outline::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                    transition: left 0.5s;
                }

                .btn-outline:hover::before {
                    left: 100%;
                }

                .btn-outline:hover {
                    background: linear-gradient(135deg, #3b82f6, #2563eb);
                    color: white;
                    transform: translateY(-2px) scale(1.05);
                    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
                }

                /* 快速发送样式 */
                .quick-send {
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                }

                .quick-send label {
                    font-size: 12px;
                    font-weight: 500;
                    color: #64748b;
                }

                .quick-send-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 8px;
                }

                .quick-send-btn {
                    padding: 8px 12px;
                    border: 2px solid rgba(59, 130, 246, 0.2);
                    border-radius: 6px;
                    background: rgba(255, 255, 255, 0.9);
                    color: #3b82f6;
                    font-size: 11px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.3s ease;
                }

                .quick-send-btn:hover {
                    background: rgba(59, 130, 246, 0.1);
                    border-color: rgba(59, 130, 246, 0.4);
                    transform: translateY(-2px);
                }

                /* 协议解析样式 */
                .protocol-container {
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                }

                .protocol-selector {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }

                .protocol-selector label {
                    font-size: 12px;
                    font-weight: 500;
                    color: #64748b;
                }

                .protocol-config {
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                    padding: 15px;
                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(14, 165, 233, 0.05) 100%);
                    border-radius: 8px;
                    border: 1px solid rgba(59, 130, 246, 0.2);
                }

                .config-item {
                    display: flex;
                    flex-direction: column;
                    gap: 6px;
                }

                .config-item label {
                    font-size: 11px;
                    font-weight: 500;
                    color: #64748b;
                }

                .config-item input {
                    width: 100%;
                    padding: 8px 10px;
                    border: 2px solid rgba(59, 130, 246, 0.2);
                    border-radius: 6px;
                    background: rgba(255, 255, 255, 0.9);
                    color: #1e293b;
                    font-size: 11px;
                    transition: all 0.3s ease;
                }

                .config-item input:focus {
                    outline: none;
                    border-color: #3b82f6;
                    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
                }

                .protocol-status {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                    padding: 12px;
                    background: rgba(255, 255, 255, 0.8);
                    border-radius: 8px;
                    border: 1px solid rgba(59, 130, 246, 0.1);
                }

                .status-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    font-size: 11px;
                }

                .status-item label {
                    color: #64748b;
                    font-weight: 500;
                }

                .status-item span {
                    color: #1e293b;
                    font-weight: 600;
                    font-family: 'Courier New', monospace;
                }

                /* 统计信息样式 */
                .statistics-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                    margin-bottom: 15px;
                }

                .stat-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 8px 12px;
                    background: rgba(59, 130, 246, 0.05);
                    border-radius: 6px;
                    border: 1px solid rgba(59, 130, 246, 0.1);
                    font-size: 11px;
                }

                .stat-item label {
                    color: #64748b;
                    font-weight: 500;
                }

                .stat-item span {
                    color: #1e293b;
                    font-weight: 600;
                    font-family: 'Courier New', monospace;
                }

                .statistics-actions {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                }

                /* 自定义滚动条样式 */
                .control-panel::-webkit-scrollbar {
                    width: 8px;
                }

                .control-panel::-webkit-scrollbar-track {
                    background: rgba(148, 163, 184, 0.1);
                    border-radius: 4px;
                }

                .control-panel::-webkit-scrollbar-thumb {
                    background: rgba(59, 130, 246, 0.3);
                    border-radius: 4px;
                    transition: background 0.3s ease;
                }

                .control-panel::-webkit-scrollbar-thumb:hover {
                    background: rgba(59, 130, 246, 0.5);
                }

                .monitor-display::-webkit-scrollbar {
                    width: 6px;
                }

                .monitor-display::-webkit-scrollbar-track {
                    background: rgba(148, 163, 184, 0.2);
                    border-radius: 3px;
                }

                .monitor-display::-webkit-scrollbar-thumb {
                    background: rgba(59, 130, 246, 0.4);
                    border-radius: 3px;
                }

                .monitor-display::-webkit-scrollbar-thumb:hover {
                    background: rgba(59, 130, 246, 0.6);
                }
            </style>

            <div class="content-layout">
                <!-- 左侧控制面板 -->
                <div class="control-panel">
                    <!-- 连接方式卡片 -->
                    <div class="control-card serial-connection-card">
                        <h3>
                            <i class="fas fa-plug"></i>
                            连接设置
                        </h3>

                        <!-- 连接状态 -->
                        <div class="connection-status disconnected" id="connectionStatus">
                            <div class="status-indicator disconnected" id="statusIndicator"></div>
                            <span class="status-text" id="statusText">未连接</span>
                        </div>

                        <!-- 连接类型选择 -->
                        <div class="connection-type-selector">
                            <label>连接方式</label>
                            <div class="connection-tabs">
                                <button class="conn-tab active" data-type="serial">
                                    <i class="fab fa-usb"></i>
                                    USB串口
                                </button>
                                <button class="conn-tab" data-type="tcp">
                                    <i class="fas fa-server"></i>
                                    TCP/IP
                                </button>
                                <button class="conn-tab" data-type="websocket">
                                    <i class="fas fa-globe"></i>
                                    WebSocket
                                </button>
                                <button class="conn-tab" data-type="bluetooth">
                                    <i class="fab fa-bluetooth-b"></i>
                                    蓝牙
                                </button>
                            </div>
                        </div>

                        <!-- USB串口配置 -->
                        <div class="connection-config" id="serialConfig">                        <!-- 串口配置 -->
                        <div class="serial-config">
                            <div class="config-group" style="grid-column: 1 / -1;">
                                <label>串口选择</label>
                                <div style="display: flex; gap: 8px;">
                                    <div class="custom-select" style="flex: 1;">
                                        <select id="portSelect">
                                            <option value="">请选择串口</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-outline" id="selectPortBtn" style="padding: 8px 12px; font-size: 12px;">
                                        <i class="fas fa-search"></i>
                                        选择串口
                                    </button>
                                </div>
                            </div>
                            <div class="config-group">
                                <label>波特率</label>
                                <div class="custom-select">
                                    <select id="baudRateSelect">
                                        <option value="19200">19200</option>
                                        <option value="38400">38400</option>
                                        <option value="43000">43000</option>
                                        <option value="57600">57600</option>
                                        <option value="76800">76800</option>
                                        <option value="115200" selected>115200</option>
                                        <option value="128000">128000</option>
                                        <option value="230400">230400</option>
                                        <option value="256000">256000</option>
                                        <option value="460800">460800</option>
                                        <option value="921600">921600</option>
                                        <option value="1000000">1000000</option>
                                        <option value="2000000">2000000</option>
                                        <option value="3000000">3000000</option>
                                    </select>
                                </div>
                            </div>
                            <div class="config-group">
                                <label>数据位</label>
                                <div class="custom-select">
                                    <select id="dataBitsSelect">
                                        <option value="5">5位</option>
                                        <option value="6">6位</option>
                                        <option value="7">7位</option>
                                        <option value="8" selected>8位</option>
                                    </select>
                                </div>
                            </div>
                            <div class="config-group">
                                <label>停止位</label>
                                <div class="custom-select">
                                    <select id="stopBitsSelect">
                                        <option value="1" selected>1位</option>
                                        <option value="1.5">1.5位</option>
                                        <option value="2">2位</option>
                                    </select>
                                </div>
                            </div>
                            <div class="config-group">
                                <label>校验位</label>
                                <div class="custom-select">
                                    <select id="paritySelect">
                                        <option value="none" selected>无校验</option>
                                        <option value="even">偶校验</option>
                                        <option value="odd">奇校验</option>
                                    </select>
                                </div>
                            </div>
                            <div class="config-group">
                                <label>流控制</label>
                                <div class="custom-select">
                                    <select id="flowControlSelect">
                                        <option value="none" selected>无</option>
                                        <option value="hardware">硬件(RTS/CTS)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- TCP/IP配置 -->
                        <div class="connection-config" id="tcpConfig" style="display: none;">
                            <div class="serial-config">
                                <div class="config-group" style="grid-column: 1 / -1;">
                                    <label>连接模式</label>
                                    <div class="custom-select">
                                        <select id="tcpModeSelect">
                                            <option value="client" selected>TCP客户端</option>
                                            <option value="server">TCP服务器</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="config-group">
                                    <label>IP地址</label>
                                    <input type="text" id="tcpHostInput" placeholder="192.168.1.100" value="192.168.1.100">
                                </div>
                                <div class="config-group">
                                    <label>端口号</label>
                                    <input type="number" id="tcpPortInput" placeholder="8080" value="8080" min="1" max="65535">
                                </div>
                                <div class="config-group">
                                    <label>超时时间(ms)</label>
                                    <input type="number" id="tcpTimeoutInput" placeholder="5000" value="5000" min="1000" max="30000">
                                </div>
                                <div class="config-group">
                                    <label>心跳间隔(ms)</label>
                                    <input type="number" id="tcpHeartbeatInput" placeholder="30000" value="30000" min="0" max="300000">
                                </div>
                            </div>
                            <div class="tcp-history">
                                <label>历史连接</label>
                                <div class="history-list" id="tcpHistoryList">
                                    <div class="history-item" data-host="192.168.1.100" data-port="8080">
                                        <span>192.168.1.100:8080</span>
                                        <button class="btn-small"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- WebSocket配置 -->
                        <div class="connection-config" id="websocketConfig" style="display: none;">
                            <div class="serial-config">
                                <div class="config-group" style="grid-column: 1 / -1;">
                                    <label>WebSocket URL</label>
                                    <input type="text" id="wsUrlInput" placeholder="ws://192.168.1.100:8080/ws" value="ws://192.168.1.100:8080/ws">
                                </div>
                                <div class="config-group">
                                    <label>协议</label>
                                    <div class="custom-select">
                                        <select id="wsProtocolSelect">
                                            <option value="ws" selected>ws://</option>
                                            <option value="wss">wss:// (安全)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="config-group">
                                    <label>子协议</label>
                                    <input type="text" id="wsSubprotocolInput" placeholder="可选" value="">
                                </div>
                                <div class="config-group" style="grid-column: 1 / -1;">
                                    <label>
                                        <input type="checkbox" id="wsAutoReconnect" checked>
                                        自动重连
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 蓝牙配置 -->
                        <div class="connection-config" id="bluetoothConfig" style="display: none;">
                            <div class="serial-config">
                                <div class="config-group" style="grid-column: 1 / -1;">
                                    <label>蓝牙设备</label>
                                    <div style="display: flex; gap: 8px;">
                                        <div class="custom-select" style="flex: 1;">
                                            <select id="bluetoothDeviceSelect">
                                                <option value="">请选择蓝牙设备</option>
                                            </select>
                                        </div>
                                        <button class="btn btn-outline" id="scanBluetoothBtn" style="padding: 8px 12px; font-size: 12px;">
                                            <i class="fas fa-search"></i>
                                            扫描
                                        </button>
                                    </div>
                                </div>
                                <div class="config-group" style="grid-column: 1 / -1;">
                                    <label>服务UUID</label>
                                    <input type="text" id="btServiceUuidInput" placeholder="0000ffe0-0000-1000-8000-00805f9b34fb" value="0000ffe0-0000-1000-8000-00805f9b34fb">
                                </div>
                                <div class="config-group" style="grid-column: 1 / -1;">
                                    <label>特征UUID</label>
                                    <input type="text" id="btCharacteristicUuidInput" placeholder="0000ffe1-0000-1000-8000-00805f9b34fb" value="0000ffe1-0000-1000-8000-00805f9b34fb">
                                </div>
                            </div>
                            <div class="bluetooth-info">
                                <p><i class="fas fa-info-circle"></i> 蓝牙串口需要浏览器支持Web Bluetooth API</p>
                            </div>
                        </div>

                        <!-- 连接按钮 -->
                        <div class="connection-buttons">
                            <button class="btn btn-connect" id="connectBtn">
                                <i class="fas fa-play"></i>
                                连接
                            </button>
                            <button class="btn btn-disconnect" id="disconnectBtn" disabled>
                                <i class="fas fa-stop"></i>
                                断开
                            </button>
                        </div>
                    </div>

                    <!-- 串口监视器卡片 -->
                    <div class="control-card">
                        <h3>
                            <i class="fas fa-eye"></i>
                            数据监视器
                            <div class="monitor-status" id="monitorStatus">
                                <span class="status-badge receiving">接收中</span>
                            </div>
                        </h3>

                        <div class="monitor-container">
                            <div class="monitor-header">
                                <div class="monitor-controls">
                                    <button class="btn-small btn-clear" id="clearMonitorBtn">
                                        <i class="fas fa-trash"></i>
                                        清空
                                    </button>
                                    <button class="btn-small btn-pause" id="pauseMonitorBtn">
                                        <i class="fas fa-pause"></i>
                                        暂停
                                    </button>
                                </div>
                            </div>
                            <div class="monitor-display" id="monitorDisplay">
                                <div class="monitor-placeholder">
                                    <i class="fas fa-terminal"></i>
                                    <p>等待串口数据...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 数据发送卡片 -->
                    <div class="control-card">
                        <h3>
                            <i class="fas fa-paper-plane"></i>
                            数据发送
                        </h3>

                        <div class="send-container">
                            <div class="send-input-group">
                                <label>发送数据 (HEX格式)</label>
                                <textarea id="sendDataInput" placeholder="例如: D0 D1 D2 D3 D4 D5 D6 D7" rows="3"></textarea>
                            </div>

                            <div class="send-options">
                                <div class="send-format">
                                    <label>发送格式</label>
                                    <div class="custom-select">
                                        <select id="sendFormatSelect">
                                            <option value="hex" selected>HEX</option>
                                            <option value="ascii">ASCII</option>
                                            <option value="decimal">十进制</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="send-interval">
                                    <label>发送间隔 (ms)</label>
                                    <input type="number" id="sendIntervalInput" value="1000" min="10" max="10000">
                                </div>
                            </div>

                            <div class="send-buttons">
                                <button class="btn btn-primary" id="sendOnceBtn">
                                    <i class="fas fa-paper-plane"></i>
                                    发送一次
                                </button>
                                <button class="btn btn-outline" id="sendRepeatBtn">
                                    <i class="fas fa-repeat"></i>
                                    循环发送
                                </button>
                            </div>

                            <!-- 快速发送预设 -->
                            <div class="quick-send">
                                <label>快速发送</label>
                                <div class="quick-send-grid">
                                    <button class="quick-send-btn" data-value="AA BB CC DD">测试数据1</button>
                                    <button class="quick-send-btn" data-value="01 02 03 04">测试数据2</button>
                                    <button class="quick-send-btn" data-value="FF FE FD FC">测试数据3</button>
                                    <button class="quick-send-btn" data-value="00 11 22 33">测试数据4</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 协议解析卡片 -->
                    <div class="control-card">
                        <h3>
                            <i class="fas fa-code"></i>
                            协议解析
                        </h3>

                        <div class="protocol-container">
                            <div class="protocol-selector">
                                <label>协议类型</label>
                                <div class="custom-select">
                                    <select id="protocolSelect">
                                        <option value="none">无协议</option>
                                        <option value="modbus">Modbus RTU</option>
                                        <option value="custom">自定义协议</option>
                                    </select>
                                </div>
                            </div>

                            <div class="protocol-config" id="protocolConfig" style="display: none;">
                                <div class="config-item">
                                    <label>帧头</label>
                                    <input type="text" id="frameHeaderInput" placeholder="例如: AA BB">
                                </div>
                                <div class="config-item">
                                    <label>帧尾</label>
                                    <input type="text" id="frameFooterInput" placeholder="例如: 0D 0A">
                                </div>
                                <div class="config-item">
                                    <label>数据长度位置</label>
                                    <input type="number" id="lengthPositionInput" placeholder="字节位置" min="0">
                                </div>
                            </div>

                            <div class="protocol-status">
                                <div class="status-item">
                                    <label>已解析帧数:</label>
                                    <span id="parsedFrameCount">0</span>
                                </div>
                                <div class="status-item">
                                    <label>错误帧数:</label>
                                    <span id="errorFrameCount">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 统计信息卡片 -->
                    <div class="control-card">
                        <h3>
                            <i class="fas fa-chart-bar"></i>
                            统计信息
                        </h3>

                        <div class="statistics-grid">
                            <div class="stat-item">
                                <label>接收字节数:</label>
                                <span id="receivedBytesCount">0</span>
                            </div>
                            <div class="stat-item">
                                <label>发送字节数:</label>
                                <span id="sentBytesCount">0</span>
                            </div>
                            <div class="stat-item">
                                <label>数据包数:</label>
                                <span id="packetCount">0</span>
                            </div>
                            <div class="stat-item">
                                <label>连接时长:</label>
                                <span id="connectionTime">00:00:00</span>
                            </div>
                            <div class="stat-item">
                                <label>传输速率:</label>
                                <span id="transferRate">0 B/s</span>
                            </div>
                            <div class="stat-item">
                                <label>错误率:</label>
                                <span id="errorRate">0%</span>
                            </div>
                        </div>

                        <div class="statistics-actions">
                            <button class="btn btn-outline btn-small" id="resetStatsBtn">
                                <i class="fas fa-redo"></i>
                                重置统计
                            </button>
                            <button class="btn btn-primary btn-small" id="exportStatsBtn">
                                <i class="fas fa-download"></i>
                                导出报告
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 右侧可视化区域 -->
                <div class="visualization-area">
                    <style>
                        /* 右侧可视化区域样式 - 与data页面完全一致 */
                        .visualization-area {
                            background: rgba(255, 255, 255, 0.95);
                            backdrop-filter: blur(25px);
                            border-radius: 20px;
                            padding: 25px;
                            box-shadow:
                                0 12px 45px rgba(0, 0, 0, 0.06),
                                0 6px 25px rgba(59, 130, 246, 0.08),
                                inset 0 1px 0 rgba(255, 255, 255, 0.8);
                            border: 1px solid rgba(255, 255, 255, 0.3);
                            overflow: visible;
                            display: flex;
                            flex-direction: column;
                            position: relative;
                            min-width: 1000px;
                            min-height: calc(100vh - 60px);
                            height: calc(100vh - 60px);
                        }

                        .visualization-area::before {
                            content: '';
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            height: 1px;
                            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent);
                        }

                        .visualization-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 8px;
                            padding-bottom: 6px;
                            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
                            flex-shrink: 0;
                            height: 40px;
                            min-height: 40px;
                        }

                        .visualization-title {
                            font-size: 18px;
                            font-weight: 700;
                            color: #1e293b;
                            margin: 0;
                            background: linear-gradient(135deg, #3b82f6, #0ea5e9);
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                            background-clip: text;
                        }

                        .visualization-actions {
                            display: flex;
                            gap: 10px;
                        }

                        .btn-small {
                            padding: 6px 14px;
                            font-size: 11px;
                            width: auto;
                        }

                        /* 图表网格样式 - 上下两张图布局 */
                        .charts-grid {
                            display: grid;
                            grid-template-columns: 1fr;
                            grid-template-rows: 1fr 1fr;
                            gap: 12px;
                            width: 100%;
                            min-width: 1000px;
                            padding: 0;
                            align-items: stretch;
                            justify-items: stretch;
                            flex: 1;
                            min-height: 0;
                            box-sizing: border-box;
                        }

                        .chart-card {
                            background: rgba(255, 255, 255, 0.95);
                            border-radius: 12px;
                            padding: 12px;
                            box-shadow:
                                0 8px 30px rgba(0, 0, 0, 0.06),
                                0 4px 15px rgba(59, 130, 246, 0.08),
                                inset 0 1px 0 rgba(255, 255, 255, 0.8);
                            border: 2px solid rgba(255, 255, 255, 0.8);
                            transition: all 0.3s ease;
                            position: relative;
                            overflow: hidden;
                            display: flex;
                            flex-direction: column;
                            width: 100%;
                            height: 100%;
                            min-height: 0;
                            box-sizing: border-box;
                        }

                        .chart-card::before {
                            content: '';
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            height: 1px;
                            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.2), transparent);
                        }

                        .chart-card:hover {
                            box-shadow:
                                0 15px 40px rgba(0, 0, 0, 0.08),
                                0 6px 20px rgba(59, 130, 246, 0.12),
                                inset 0 1px 0 rgba(255, 255, 255, 0.8);
                            border-color: rgba(255, 255, 255, 0.6);
                        }

                        .chart-card:active {
                            transition: all 0.1s ease;
                        }

                        .chart-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 6px;
                            padding-bottom: 4px;
                            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
                            flex-shrink: 0;
                            height: 32px;
                            min-height: 32px;
                            overflow: hidden;
                        }

                        .chart-title {
                            display: flex;
                            align-items: center;
                            gap: 6px;
                            font-size: 13px;
                            font-weight: 600;
                            color: #1e293b;
                            margin: 0;
                            flex-shrink: 0;
                        }

                        .chart-title i {
                            color: #3b82f6;
                            font-size: 14px;
                        }

                        .chart-actions {
                            display: flex;
                            gap: 4px;
                            flex-wrap: nowrap;
                            align-items: center;
                        }

                        .chart-btn {
                            width: 28px;
                            height: 28px;
                            border: none;
                            background: rgba(59, 130, 246, 0.1);
                            color: #3b82f6;
                            border-radius: 6px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.3s ease;
                            font-size: 12px;
                            flex-shrink: 0;
                        }

                        .chart-btn:hover {
                            background: rgba(59, 130, 246, 0.2);
                            transform: scale(1.05);
                        }

                        .operation-select {
                            padding: 6px 24px 6px 10px;
                            border: 2px solid transparent;
                            border-radius: 8px;
                            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
                            backdrop-filter: blur(15px);
                            color: #1e293b;
                            font-size: 11px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                            margin-right: 6px;
                            box-shadow:
                                0 3px 12px rgba(0, 0, 0, 0.08),
                                0 1px 6px rgba(59, 130, 246, 0.1),
                                inset 0 1px 0 rgba(255, 255, 255, 0.8);
                            position: relative;
                            appearance: none;
                            -webkit-appearance: none;
                            -moz-appearance: none;
                            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
                            background-repeat: no-repeat;
                            background-position: right 6px center;
                            background-size: 12px;
                            flex-shrink: 0;
                        }

                        .operation-select:hover {
                            border-color: rgba(59, 130, 246, 0.3);
                            box-shadow:
                                0 5px 20px rgba(0, 0, 0, 0.12),
                                0 3px 12px rgba(59, 130, 246, 0.15),
                                inset 0 1px 0 rgba(255, 255, 255, 0.9);
                            transform: translateY(-1px);
                            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232563eb' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
                        }

                        .operation-select:focus {
                            outline: none;
                            border-color: #3b82f6;
                            box-shadow:
                                0 6px 25px rgba(0, 0, 0, 0.15),
                                0 3px 15px rgba(59, 130, 246, 0.25),
                                0 0 0 3px rgba(59, 130, 246, 0.1),
                                inset 0 1px 0 rgba(255, 255, 255, 1);
                            transform: translateY(-2px);
                            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%231d4ed8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
                        }

                        /* 选项样式 */
                        .operation-select option {
                            padding: 10px 12px;
                            background: rgba(255, 255, 255, 0.95);
                            color: #1e293b;
                            font-weight: 500;
                            border: none;
                        }

                        .operation-select option:hover {
                            background: rgba(59, 130, 246, 0.1);
                        }

                        .operation-select option:checked {
                            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(14, 165, 233, 0.15) 100%);
                            color: #1d4ed8;
                            font-weight: 600;
                        }

                        .chart-body {
                            flex: 1;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(14, 165, 233, 0.08) 100%);
                            border-radius: 10px;
                            position: relative;
                            width: 100%;
                            min-height: 0;
                            overflow: hidden;
                            padding: 0;
                            box-sizing: border-box;
                            margin: 2px;
                            border: 1px solid rgba(59, 130, 246, 0.15);
                        }

                        .chart-placeholder {
                            text-align: center;
                            color: #64748b;
                            padding: 30px 20px;
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            z-index: 1;
                        }

                        .chart-placeholder i {
                            font-size: 40px;
                            color: #3b82f6;
                            margin-bottom: 12px;
                            display: block;
                        }

                        .chart-placeholder h4 {
                            font-size: 16px;
                            font-weight: 600;
                            color: #1e293b;
                            margin: 0 0 8px 0;
                        }

                        .chart-placeholder p {
                            font-size: 14px;
                            color: #64748b;
                            margin: 0 0 8px 0;
                        }

                        .chart-placeholder small {
                            font-size: 12px;
                            color: #94a3b8;
                            font-style: italic;
                        }

                        .chart-canvas {
                            width: 100% !important;
                            height: 100% !important;
                            max-width: 100% !important;
                            max-height: 100% !important;
                            object-fit: contain;
                            display: block;
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                        }

                        .chart-canvas {
                            width: 100% !important;
                            height: 100% !important;
                            max-width: calc(100% - 20px) !important;
                            max-height: calc(100% - 20px) !important;
                            object-fit: contain;
                            display: block;
                        }
                    </style>

                    <div class="visualization-header">
                        <h2 class="visualization-title">实时数据可视化</h2>
                        <div class="visualization-actions">
                            <button class="btn btn-outline btn-small" id="exportAllBtn">
                                <i class="fas fa-download"></i>
                                导出全部
                            </button>
                            <button class="btn btn-primary btn-small" id="refreshChartsBtn">
                                <i class="fas fa-sync-alt"></i>
                                刷新图表
                            </button>
                        </div>
                    </div>

                    <!-- 图表网格 -->
                    <div class="charts-grid">
                        <!-- 上方图表卡片 -->
                        <div class="chart-card" id="topChartCard">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="fas fa-wave-square" id="topChartIcon"></i>
                                    <span id="topChartTitle">时域波形</span>
                                </h3>
                                <div class="chart-actions">
                                    <!-- 图表类型选择器 -->
                                    <select class="operation-select" id="topChartTypeSelect">
                                        <option value="time">时域波形</option>
                                        <option value="frequency">频域分析</option>
                                        <option value="envelope">包络线图</option>
                                        <option value="phase">瞬时相位</option>
                                        <option value="cdf">累积分布函数</option>
                                        <option value="psd">功率谱密度</option>
                                        <option value="vector">矢量图</option>
                                        <option value="polar">极坐标图</option>
                                        <option value="wavelet">小波变换图</option>
                                    </select>

                                    <!-- 操作按钮 -->
                                    <button class="chart-btn" data-action="zoom-x-in" data-chart="top" title="横轴放大">
                                        <i class="fas fa-search-plus"></i>
                                    </button>
                                    <button class="chart-btn" data-action="zoom-x-out" data-chart="top" title="横轴缩小">
                                        <i class="fas fa-search-minus"></i>
                                    </button>
                                    <button class="chart-btn" data-action="zoom-y-in" data-chart="top" title="纵轴放大">
                                        <i class="fas fa-arrows-alt-v"></i>
                                    </button>
                                    <button class="chart-btn" data-action="zoom-y-out" data-chart="top" title="纵轴缩小">
                                        <i class="fas fa-compress"></i>
                                    </button>
                                    <button class="chart-btn" data-action="reset" data-chart="top" title="重置">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    <button class="chart-btn" data-action="export-png" data-chart="top" title="导出PNG">
                                        <i class="fas fa-image"></i>
                                    </button>
                                    <button class="chart-btn" data-action="export-jpg" data-chart="top" title="导出JPG">
                                        <i class="fas fa-image"></i>
                                    </button>
                                    <button class="chart-btn" data-action="export-excel" data-chart="top" title="导出Excel">
                                        <i class="fas fa-table"></i>
                                    </button>
                                    <button class="chart-btn" data-action="fullscreen" data-chart="top" title="全屏">
                                        <i class="fas fa-expand-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-body">
                                <div class="chart-placeholder" id="topChartPlaceholder">
                                    <i class="fas fa-wave-square"></i>
                                    <h4>等待串口数据</h4>
                                    <p>连接串口后将显示时域波形图</p>
                                    <small>支持实时数据更新和多种分析功能</small>
                                </div>
                                <canvas id="topChartCanvas" class="chart-canvas" style="display: none;"></canvas>
                            </div>
                        </div>

                        <!-- 下方图表卡片 -->
                        <div class="chart-card" id="bottomChartCard">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="fas fa-chart-area" id="bottomChartIcon"></i>
                                    <span id="bottomChartTitle">频域分析</span>
                                </h3>
                                <div class="chart-actions">
                                    <!-- 图表类型选择器 -->
                                    <select class="operation-select" id="bottomChartTypeSelect">
                                        <option value="frequency" selected>频域分析</option>
                                        <option value="time">时域波形</option>
                                        <option value="envelope">包络线图</option>
                                        <option value="phase">瞬时相位</option>
                                        <option value="cdf">累积分布函数</option>
                                        <option value="psd">功率谱密度</option>
                                        <option value="vector">矢量图</option>
                                        <option value="polar">极坐标图</option>
                                        <option value="wavelet">小波变换图</option>
                                    </select>

                                    <!-- 操作按钮 -->
                                    <button class="chart-btn" data-action="zoom-x-in" data-chart="bottom" title="横轴放大">
                                        <i class="fas fa-search-plus"></i>
                                    </button>
                                    <button class="chart-btn" data-action="zoom-x-out" data-chart="bottom" title="横轴缩小">
                                        <i class="fas fa-search-minus"></i>
                                    </button>
                                    <button class="chart-btn" data-action="zoom-y-in" data-chart="bottom" title="纵轴放大">
                                        <i class="fas fa-arrows-alt-v"></i>
                                    </button>
                                    <button class="chart-btn" data-action="zoom-y-out" data-chart="bottom" title="纵轴缩小">
                                        <i class="fas fa-compress"></i>
                                    </button>
                                    <button class="chart-btn" data-action="reset" data-chart="bottom" title="重置">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    <button class="chart-btn" data-action="export-png" data-chart="bottom" title="导出PNG">
                                        <i class="fas fa-image"></i>
                                    </button>
                                    <button class="chart-btn" data-action="export-jpg" data-chart="bottom" title="导出JPG">
                                        <i class="fas fa-image"></i>
                                    </button>
                                    <button class="chart-btn" data-action="export-excel" data-chart="bottom" title="导出Excel">
                                        <i class="fas fa-table"></i>
                                    </button>
                                    <button class="chart-btn" data-action="fullscreen" data-chart="bottom" title="全屏">
                                        <i class="fas fa-expand-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-body">
                                <div class="chart-placeholder" id="bottomChartPlaceholder">
                                    <i class="fas fa-chart-area"></i>
                                    <h4>等待串口数据</h4>
                                    <p>连接串口后将显示频域分析图</p>
                                    <small>支持FFT分析和频谱可视化</small>
                                </div>
                                <canvas id="bottomChartCanvas" class="chart-canvas" style="display: none;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 检查浏览器是否支持Web Serial API
        if ("serial" in navigator) {
            console.log("浏览器支持 Web Serial API");
        } else {
            alert("您的浏览器不支持 Web Serial API，请使用Chrome、Edge或Opera浏览器");
        }

        // 全局变量
        let port = null;
        let reader = null;
        let writer = null;
        let reading = false;
        let connected = false;
        let receivedData = [];
        let topChart = null;
        let bottomChart = null;
        let currentTopChartType = 'time';
        let currentBottomChartType = 'frequency';
        let statistics = {
            receivedBytes: 0,
            sentBytes: 0,
            packets: 0,
            connectionStartTime: null,
            errors: 0
        };
        let sendInterval = null;

        // 连接类型相关变量
        let currentConnectionType = 'serial'; // serial, tcp, websocket, bluetooth
        let websocket = null;
        let tcpSocket = null;
        let bluetoothDevice = null;
        let bluetoothCharacteristic = null;

        // TCP连接历史
        let tcpHistory = JSON.parse(localStorage.getItem('tcpHistory') || '[]');

        // DOM元素
        const elements = {
            // 连接相关
            portSelect: document.getElementById('portSelect'),
            baudRateSelect: document.getElementById('baudRateSelect'),
            dataBitsSelect: document.getElementById('dataBitsSelect'),
            stopBitsSelect: document.getElementById('stopBitsSelect'),
            paritySelect: document.getElementById('paritySelect'),
            flowControlSelect: document.getElementById('flowControlSelect'),
            connectBtn: document.getElementById('connectBtn'),
            disconnectBtn: document.getElementById('disconnectBtn'),
            connectionStatus: document.getElementById('connectionStatus'),
            statusIndicator: document.getElementById('statusIndicator'),
            statusText: document.getElementById('statusText'),

            // 连接配置面板
            serialConfig: document.getElementById('serialConfig'),
            tcpConfig: document.getElementById('tcpConfig'),
            websocketConfig: document.getElementById('websocketConfig'),
            bluetoothConfig: document.getElementById('bluetoothConfig'),

            // TCP配置
            tcpModeSelect: document.getElementById('tcpModeSelect'),
            tcpHostInput: document.getElementById('tcpHostInput'),
            tcpPortInput: document.getElementById('tcpPortInput'),
            tcpTimeoutInput: document.getElementById('tcpTimeoutInput'),
            tcpHeartbeatInput: document.getElementById('tcpHeartbeatInput'),
            tcpHistoryList: document.getElementById('tcpHistoryList'),

            // WebSocket配置
            wsUrlInput: document.getElementById('wsUrlInput'),
            wsProtocolSelect: document.getElementById('wsProtocolSelect'),
            wsSubprotocolInput: document.getElementById('wsSubprotocolInput'),
            wsAutoReconnect: document.getElementById('wsAutoReconnect'),

            // 蓝牙配置
            bluetoothDeviceSelect: document.getElementById('bluetoothDeviceSelect'),
            scanBluetoothBtn: document.getElementById('scanBluetoothBtn'),
            btServiceUuidInput: document.getElementById('btServiceUuidInput'),
            btCharacteristicUuidInput: document.getElementById('btCharacteristicUuidInput'),

            // 监视器相关
            monitorDisplay: document.getElementById('monitorDisplay'),
            monitorStatus: document.getElementById('monitorStatus'),
            clearMonitorBtn: document.getElementById('clearMonitorBtn'),
            pauseMonitorBtn: document.getElementById('pauseMonitorBtn'),

            // 发送相关
            sendDataInput: document.getElementById('sendDataInput'),
            sendFormatSelect: document.getElementById('sendFormatSelect'),
            sendIntervalInput: document.getElementById('sendIntervalInput'),
            sendOnceBtn: document.getElementById('sendOnceBtn'),
            sendRepeatBtn: document.getElementById('sendRepeatBtn'),

            // 协议相关
            protocolSelect: document.getElementById('protocolSelect'),
            protocolConfig: document.getElementById('protocolConfig'),
            frameHeaderInput: document.getElementById('frameHeaderInput'),
            frameFooterInput: document.getElementById('frameFooterInput'),
            lengthPositionInput: document.getElementById('lengthPositionInput'),
            parsedFrameCount: document.getElementById('parsedFrameCount'),
            errorFrameCount: document.getElementById('errorFrameCount'),

            // 统计相关
            receivedBytesCount: document.getElementById('receivedBytesCount'),
            sentBytesCount: document.getElementById('sentBytesCount'),
            packetCount: document.getElementById('packetCount'),
            connectionTime: document.getElementById('connectionTime'),
            transferRate: document.getElementById('transferRate'),
            errorRate: document.getElementById('errorRate'),
            resetStatsBtn: document.getElementById('resetStatsBtn'),
            exportStatsBtn: document.getElementById('exportStatsBtn'),

            // 图表相关
            topChartPlaceholder: document.getElementById('topChartPlaceholder'),
            bottomChartPlaceholder: document.getElementById('bottomChartPlaceholder'),
            topChartCanvas: document.getElementById('topChartCanvas'),
            bottomChartCanvas: document.getElementById('bottomChartCanvas'),
            topChartTitle: document.getElementById('topChartTitle'),
            bottomChartTitle: document.getElementById('bottomChartTitle'),
            topChartIcon: document.getElementById('topChartIcon'),
            bottomChartIcon: document.getElementById('bottomChartIcon'),
            topChartTypeSelect: document.getElementById('topChartTypeSelect'),
            bottomChartTypeSelect: document.getElementById('bottomChartTypeSelect'),
            exportAllBtn: document.getElementById('exportAllBtn'),
            refreshChartsBtn: document.getElementById('refreshChartsBtn')
        };

        // 连接类型切换
        function switchConnectionType(type) {
            currentConnectionType = type;
            
            // 更新标签页状态
            document.querySelectorAll('.conn-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.type === type);
            });
            
            // 显示对应配置面板
            const configs = ['serialConfig', 'tcpConfig', 'websocketConfig', 'bluetoothConfig'];
            configs.forEach(configId => {
                const el = document.getElementById(configId);
                if (el) {
                    el.style.display = configId === type + 'Config' ? 'block' : 'none';
                }
            });
        }

        // 初始化连接类型选择器
        function initConnectionTypeTabs() {
            document.querySelectorAll('.conn-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchConnectionType(tab.dataset.type);
                });
            });
        }

        // 串口设备插入与拔出事件
        if (navigator.serial) {
            navigator.serial.onconnect = (event) => {
                console.log("串口设备已连接: ", event.target);
                updatePortList();
            };

            navigator.serial.ondisconnect = (event) => {
                console.log("串口设备已断开: ", event.target);
                updatePortList();
                if (connected && event.target === port) {
                    handleDisconnection();
                }
            };
        }

        // 更新串口列表
        async function updatePortList() {
            try {
                const ports = await navigator.serial.getPorts();
                elements.portSelect.innerHTML = '<option value="">请选择串口</option>';

                ports.forEach((port, index) => {
                    const info = port.getInfo();
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `串口 ${index + 1} (VID: ${info.usbVendorId || 'N/A'}, PID: ${info.usbProductId || 'N/A'})`;
                    elements.portSelect.appendChild(option);
                });
            } catch (error) {
                console.error('获取串口列表失败:', error);
            }
        }

        // 选择串口
        async function selectPort() {
            try {
                port = await navigator.serial.requestPort();
                updatePortList();

                // 自动选择刚刚授权的串口
                const ports = await navigator.serial.getPorts();
                const portIndex = ports.indexOf(port);
                if (portIndex !== -1) {
                    elements.portSelect.value = portIndex;
                }
            } catch (error) {
                console.log('用户取消了串口选择');
            }
        }

        // 统一连接函数
        async function connect() {
            switch (currentConnectionType) {
                case 'serial':
                    await connectSerial();
                    break;
                case 'tcp':
                    await connectTCP();
                    break;
                case 'websocket':
                    await connectWebSocket();
                    break;
                case 'bluetooth':
                    await connectBluetooth();
                    break;
            }
        }

        // 统一断开函数
        async function disconnect() {
            switch (currentConnectionType) {
                case 'serial':
                    await disconnectSerial();
                    break;
                case 'tcp':
                    disconnectTCP();
                    break;
                case 'websocket':
                    disconnectWebSocket();
                    break;
                case 'bluetooth':
                    await disconnectBluetooth();
                    break;
            }
        }

        // 连接USB串口
        async function connectSerial() {
            if (!navigator.serial) {
                alert('您的浏览器不支持 Web Serial API');
                return;
            }

            if (!port) {
                const selectedIndex = elements.portSelect.value;
                if (!selectedIndex) {
                    alert('请先选择串口');
                    return;
                }

                const ports = await navigator.serial.getPorts();
                port = ports[selectedIndex];
            }

            try {
                const baudRate = parseInt(elements.baudRateSelect.value);
                const dataBits = parseInt(elements.dataBitsSelect.value);
                const stopBits = parseFloat(elements.stopBitsSelect.value);
                const parity = elements.paritySelect ? elements.paritySelect.value : 'none';
                const flowControl = elements.flowControlSelect ? elements.flowControlSelect.value : 'none';

                await port.open({
                    baudRate: baudRate,
                    dataBits: dataBits,
                    stopBits: stopBits,
                    parity: parity,
                    flowControl: flowControl
                });

                connected = true;
                statistics.connectionStartTime = Date.now();
                updateConnectionStatus(true);
                startReading();

                console.log('串口连接成功');
            } catch (error) {
                console.error('串口连接失败:', error);
                alert('串口连接失败: ' + error.message);
            }
        }

        // 断开USB串口
        async function disconnectSerial() {
            if (!connected || !port) return;

            try {
                reading = false;
                if (reader) {
                    await reader.cancel();
                }
                if (writer) {
                    writer.releaseLock();
                }
                await port.close();

                handleDisconnection();
                console.log('串口已断开');
            } catch (error) {
                console.error('断开串口失败:', error);
            }
        }

        // 连接TCP/IP（通过WebSocket代理，因为浏览器不支持原生TCP）
        async function connectTCP() {
            const host = elements.tcpHostInput.value.trim();
            const port = parseInt(elements.tcpPortInput.value);
            
            if (!host || !port) {
                alert('请输入有效的IP地址和端口号');
                return;
            }

            try {
                // 由于浏览器安全限制，TCP连接需要通过WebSocket代理
                // 这里使用WebSocket模拟TCP连接
                const wsUrl = `ws://${host}:${port}`;
                
                updateConnectionStatus(false, '连接中...');
                
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = () => {
                    connected = true;
                    statistics.connectionStartTime = Date.now();
                    updateConnectionStatus(true);
                    addToTcpHistory(host, port);
                    console.log('TCP连接成功 (通过WebSocket)');
                };
                
                websocket.onmessage = (event) => {
                    if (event.data instanceof ArrayBuffer) {
                        const data = new Uint8Array(event.data);
                        handleReceivedBinaryData(data);
                    } else {
                        handleReceivedTextData(event.data);
                    }
                };
                
                websocket.onerror = (error) => {
                    console.error('TCP连接错误:', error);
                    alert('TCP连接失败，请确保目标设备支持WebSocket或使用专用的TCP-WebSocket代理');
                };
                
                websocket.onclose = () => {
                    if (connected) {
                        handleDisconnection();
                    }
                };
                
            } catch (error) {
                console.error('TCP连接失败:', error);
                alert('TCP连接失败: ' + error.message);
            }
        }

        // 断开TCP连接
        function disconnectTCP() {
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            handleDisconnection();
        }

        // 添加TCP历史记录
        function addToTcpHistory(host, port) {
            const entry = { host, port, time: Date.now() };
            tcpHistory = tcpHistory.filter(h => !(h.host === host && h.port === port));
            tcpHistory.unshift(entry);
            tcpHistory = tcpHistory.slice(0, 10); // 保留最近10条
            localStorage.setItem('tcpHistory', JSON.stringify(tcpHistory));
            updateTcpHistoryUI();
        }

        // 更新TCP历史记录UI
        function updateTcpHistoryUI() {
            if (!elements.tcpHistoryList) return;
            
            elements.tcpHistoryList.innerHTML = tcpHistory.map(h => `
                <div class="history-item" data-host="${h.host}" data-port="${h.port}">
                    <span>${h.host}:${h.port}</span>
                    <button class="btn-small" onclick="removeTcpHistory('${h.host}', ${h.port})"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
            
            // 添加点击事件
            elements.tcpHistoryList.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'I') {
                        elements.tcpHostInput.value = item.dataset.host;
                        elements.tcpPortInput.value = item.dataset.port;
                    }
                });
            });
        }

        // 删除TCP历史记录
        function removeTcpHistory(host, port) {
            tcpHistory = tcpHistory.filter(h => !(h.host === host && h.port === port));
            localStorage.setItem('tcpHistory', JSON.stringify(tcpHistory));
            updateTcpHistoryUI();
        }

        // 连接WebSocket
        async function connectWebSocket() {
            let url = elements.wsUrlInput.value.trim();
            
            if (!url) {
                alert('请输入WebSocket URL');
                return;
            }

            // 确保URL有正确的协议前缀
            if (!url.startsWith('ws://') && !url.startsWith('wss://')) {
                const protocol = elements.wsProtocolSelect.value;
                url = protocol + '://' + url;
            }

            try {
                updateConnectionStatus(false, '连接中...');
                
                const subprotocol = elements.wsSubprotocolInput.value.trim();
                websocket = subprotocol ? new WebSocket(url, [subprotocol]) : new WebSocket(url);
                
                websocket.binaryType = 'arraybuffer';
                
                websocket.onopen = () => {
                    connected = true;
                    statistics.connectionStartTime = Date.now();
                    updateConnectionStatus(true);
                    console.log('WebSocket连接成功');
                };
                
                websocket.onmessage = (event) => {
                    if (event.data instanceof ArrayBuffer) {
                        const data = new Uint8Array(event.data);
                        handleReceivedBinaryData(data);
                    } else {
                        handleReceivedTextData(event.data);
                    }
                };
                
                websocket.onerror = (error) => {
                    console.error('WebSocket错误:', error);
                    statistics.errors++;
                };
                
                websocket.onclose = (event) => {
                    console.log('WebSocket关闭:', event.code, event.reason);
                    if (connected) {
                        handleDisconnection();
                        // 自动重连
                        if (elements.wsAutoReconnect && elements.wsAutoReconnect.checked) {
                            setTimeout(() => {
                                if (!connected) {
                                    console.log('尝试自动重连...');
                                    connectWebSocket();
                                }
                            }, 3000);
                        }
                    }
                };
                
            } catch (error) {
                console.error('WebSocket连接失败:', error);
                alert('WebSocket连接失败: ' + error.message);
            }
        }

        // 断开WebSocket
        function disconnectWebSocket() {
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            handleDisconnection();
        }

        // 连接蓝牙
        async function connectBluetooth() {
            if (!navigator.bluetooth) {
                alert('您的浏览器不支持 Web Bluetooth API');
                return;
            }

            try {
                const serviceUuid = elements.btServiceUuidInput.value.trim();
                const characteristicUuid = elements.btCharacteristicUuidInput.value.trim();

                updateConnectionStatus(false, '扫描中...');

                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [serviceUuid] }],
                    optionalServices: [serviceUuid]
                });

                updateConnectionStatus(false, '连接中...');

                const server = await bluetoothDevice.gatt.connect();
                const service = await server.getPrimaryService(serviceUuid);
                bluetoothCharacteristic = await service.getCharacteristic(characteristicUuid);

                // 启用通知
                await bluetoothCharacteristic.startNotifications();
                bluetoothCharacteristic.addEventListener('characteristicvaluechanged', handleBluetoothData);

                connected = true;
                statistics.connectionStartTime = Date.now();
                updateConnectionStatus(true);

                bluetoothDevice.addEventListener('gattserverdisconnected', () => {
                    if (connected) {
                        handleDisconnection();
                    }
                });

                console.log('蓝牙连接成功');
            } catch (error) {
                console.error('蓝牙连接失败:', error);
                alert('蓝牙连接失败: ' + error.message);
                handleDisconnection();
            }
        }

        // 断开蓝牙
        async function disconnectBluetooth() {
            if (bluetoothCharacteristic) {
                try {
                    await bluetoothCharacteristic.stopNotifications();
                } catch (e) {}
            }
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
            }
            bluetoothDevice = null;
            bluetoothCharacteristic = null;
            handleDisconnection();
        }

        // 处理蓝牙数据
        function handleBluetoothData(event) {
            const value = event.target.value;
            const data = new Uint8Array(value.buffer);
            handleReceivedBinaryData(data);
        }

        // 扫描蓝牙设备
        async function scanBluetoothDevices() {
            if (!navigator.bluetooth) {
                alert('您的浏览器不支持 Web Bluetooth API');
                return;
            }

            try {
                const serviceUuid = elements.btServiceUuidInput.value.trim();
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [serviceUuid] }],
                    optionalServices: [serviceUuid]
                });

                // 添加到选择列表
                const option = document.createElement('option');
                option.value = device.id;
                option.textContent = device.name || '未知设备';
                option.dataset.device = JSON.stringify({ id: device.id, name: device.name });
                elements.bluetoothDeviceSelect.appendChild(option);
                elements.bluetoothDeviceSelect.value = device.id;

                bluetoothDevice = device;
            } catch (error) {
                console.log('蓝牙扫描取消或失败:', error);
            }
        }

        // 处理断开连接
        function handleDisconnection() {
            connected = false;
            reading = false;
            port = null;
            reader = null;
            writer = null;
            statistics.connectionStartTime = null; // 重置连接时长
            updateConnectionStatus(false);
            stopSendInterval();
        }

        // 更新连接状态
        function updateConnectionStatus(isConnected, statusMessage = null) {
            if (isConnected) {
                elements.connectionStatus.className = 'connection-status connected';
                elements.statusIndicator.className = 'status-indicator connected';
                elements.statusText.textContent = statusMessage || '已连接';
                elements.connectBtn.disabled = true;
                elements.disconnectBtn.disabled = false;
                elements.sendOnceBtn.disabled = false;
                elements.sendRepeatBtn.disabled = false;
            } else {
                elements.connectionStatus.className = 'connection-status disconnected';
                elements.statusIndicator.className = 'status-indicator disconnected';
                elements.statusText.textContent = statusMessage || '未连接';
                elements.connectBtn.disabled = statusMessage ? true : false;
                elements.disconnectBtn.disabled = statusMessage ? true : true;
                elements.sendOnceBtn.disabled = true;
                elements.sendRepeatBtn.disabled = true;
            }
        }

        // 开始读取数据
        async function startReading() {
            reading = true;

            while (port.readable && reading) {
                reader = port.readable.getReader();
                try {
                    while (reading) {
                        const { value, done } = await reader.read();
                        if (done) break;

                        handleReceivedData(value);
                    }
                } catch (error) {
                    console.error('读取数据错误:', error);
                    statistics.errors++;
                } finally {
                    reader.releaseLock();
                }
            }
        }

        // 处理接收到的数据
        function handleReceivedData(data) {
            statistics.receivedBytes += data.length;
            statistics.packets++;

            // 转换为十六进制字符串显示
            const hexString = Array.from(data)
                .map(byte => byte.toString(16).toUpperCase().padStart(2, '0'))
                .join(' ');

            // 显示在监视器中
            displayInMonitor(hexString, 'received');

            // 解析数据为数值（假设是浮点数据）
            const values = parseDataToNumbers(data);
            if (values.length > 0) {
                receivedData.push(...values);
                // 限制数据长度，保持最新的1000个点
                if (receivedData.length > 1000) {
                    receivedData = receivedData.slice(-1000);
                }
                updateCharts();
            }

            updateStatistics();
        }

        // 处理接收到的二进制数据（用于WebSocket/蓝牙）
        function handleReceivedBinaryData(data) {
            // 直接调用handleReceivedData处理Uint8Array数据
            handleReceivedData(data);
        }

        // 处理接收到的文本数据（用于WebSocket文本消息）
        function handleReceivedTextData(text) {
            statistics.receivedBytes += text.length;
            statistics.packets++;

            // 显示在监视器中
            displayInMonitor(text, 'received');

            // 尝试解析为数值
            const values = text.split(/[\s,;]+/).map(s => parseFloat(s.trim())).filter(n => !isNaN(n) && isFinite(n));
            if (values.length > 0) {
                receivedData.push(...values);
                if (receivedData.length > 1000) {
                    receivedData = receivedData.slice(-1000);
                }
                updateCharts();
            }

            updateStatistics();
        }

        // 将字节数据解析为数值
        function parseDataToNumbers(data) {
            const values = [];

            // 假设数据是以4字节浮点数传输
            for (let i = 0; i < data.length - 3; i += 4) {
                const bytes = new Uint8Array([data[i], data[i+1], data[i+2], data[i+3]]);
                const view = new DataView(bytes.buffer);
                try {
                    const value = view.getFloat32(0, true); // 小端序
                    if (!isNaN(value) && isFinite(value)) {
                        values.push(value);
                    }
                } catch (e) {
                    // 如果不是浮点数，尝试解析为整数
                    try {
                        const value = view.getInt32(0, true);
                        values.push(value);
                    } catch (e2) {
                        // 最后尝试直接使用字节值
                        values.push(data[i]);
                    }
                }
            }

            return values;
        }

        // 在监视器中显示数据
        function displayInMonitor(data, type = 'received') {
            const timestamp = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = `monitor-line ${type}`;
            line.innerHTML = `<span style="color: #64748b;">[${timestamp}]</span> ${type === 'received' ? 'RX:' : 'TX:'} ${data}`;

            // 移除占位符
            const placeholder = elements.monitorDisplay.querySelector('.monitor-placeholder');
            if (placeholder) {
                placeholder.remove();
            }

            elements.monitorDisplay.appendChild(line);
            elements.monitorDisplay.scrollTop = elements.monitorDisplay.scrollHeight;

            // 限制显示行数
            const lines = elements.monitorDisplay.querySelectorAll('.monitor-line');
            if (lines.length > 100) {
                lines[0].remove();
            }
        }

        // 发送数据 - 支持所有连接类型
        async function sendData(data, format = 'hex') {
            if (!connected) {
                alert('请先建立连接');
                return;
            }

            try {
                let bytes;

                switch (format) {
                    case 'hex':
                        bytes = hexStringToBytes(data);
                        break;
                    case 'ascii':
                        bytes = new TextEncoder().encode(data);
                        break;
                    case 'decimal':
                        bytes = decimalStringToBytes(data);
                        break;
                    default:
                        bytes = hexStringToBytes(data);
                }

                // 根据连接类型发送数据
                switch (currentConnectionType) {
                    case 'serial':
                        if (!port) {
                            alert('串口未连接');
                            return;
                        }
                        if (!writer) {
                            writer = port.writable.getWriter();
                        }
                        await writer.write(bytes);
                        break;

                    case 'tcp':
                        // TCP通过WebSocket代理发送（浏览器不支持原生TCP）
                        if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                            alert('TCP未连接');
                            return;
                        }
                        websocket.send(bytes);
                        break;

                    case 'websocket':
                        if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                            alert('WebSocket未连接');
                            return;
                        }
                        websocket.send(bytes);
                        break;

                    case 'bluetooth':
                        if (!bluetoothCharacteristic) {
                            alert('蓝牙未连接');
                            return;
                        }
                        await bluetoothCharacteristic.writeValue(bytes);
                        break;

                    default:
                        alert('未知连接类型');
                        return;
                }

                statistics.sentBytes += bytes.length;

                // 显示在监视器中
                const hexString = Array.from(bytes)
                    .map(byte => byte.toString(16).toUpperCase().padStart(2, '0'))
                    .join(' ');
                displayInMonitor(hexString, 'sent');

                updateStatistics();

            } catch (error) {
                console.error('发送数据失败:', error);
                alert('发送数据失败: ' + error.message);
                statistics.errors++;
            }
        }

        // 十六进制字符串转字节数组
        function hexStringToBytes(hexString) {
            const cleanHex = hexString.replace(/\s+/g, '');
            if (cleanHex.length % 2 !== 0 || !/^[0-9a-fA-F]+$/.test(cleanHex)) {
                throw new Error('无效的十六进制格式');
            }

            const bytes = new Uint8Array(cleanHex.length / 2);
            for (let i = 0; i < cleanHex.length; i += 2) {
                bytes[i / 2] = parseInt(cleanHex.substr(i, 2), 16);
            }
            return bytes;
        }

        // 十进制字符串转字节数组
        function decimalStringToBytes(decString) {
            const numbers = decString.split(/\s+/).map(s => parseInt(s.trim()));
            return new Uint8Array(numbers.filter(n => !isNaN(n) && n >= 0 && n <= 255));
        }

        // 更新统计信息
        function updateStatistics() {
            elements.receivedBytesCount.textContent = statistics.receivedBytes.toLocaleString();
            elements.sentBytesCount.textContent = statistics.sentBytes.toLocaleString();
            elements.packetCount.textContent = statistics.packets.toLocaleString();

            if (statistics.connectionStartTime && connected) {
                const duration = Date.now() - statistics.connectionStartTime;
                const hours = Math.floor(duration / 3600000);
                const minutes = Math.floor((duration % 3600000) / 60000);
                const seconds = Math.floor((duration % 60000) / 1000);
                elements.connectionTime.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                const rate = (statistics.receivedBytes + statistics.sentBytes) / (duration / 1000);
                elements.transferRate.textContent = `${rate.toFixed(1)} B/s`;
            } else {
                elements.connectionTime.textContent = '00:00:00';
                elements.transferRate.textContent = '0.0 B/s';
            }

            const errorRate = statistics.packets > 0 ? (statistics.errors / statistics.packets * 100) : 0;
            elements.errorRate.textContent = `${errorRate.toFixed(2)}%`;
        }

        // 停止发送间隔
        function stopSendInterval() {
            if (sendInterval) {
                clearInterval(sendInterval);
                sendInterval = null;
                elements.sendRepeatBtn.innerHTML = '<i class="fas fa-repeat"></i> 循环发送';
            }
        }

        // 初始化图表
        function initCharts() {
            // 初始化上方图表
            const topCtx = elements.topChartCanvas.getContext('2d');
            topChart = new Chart(topCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '时域波形',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    layout: {
                        padding: {
                            top: 10,
                            right: 10,
                            bottom: 10,
                            left: 10
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '时间 (秒)',
                                font: { size: 12, weight: 'bold' }
                            },
                            type: 'linear',
                            ticks: {
                                maxTicksLimit: 10,
                                callback: function(value) {
                                    return value.toFixed(2) + 's';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '幅值',
                                font: { size: 12, weight: 'bold' }
                            },
                            ticks: {
                                maxTicksLimit: 8,
                                callback: function(value) {
                                    return value.toFixed(1);
                                }
                            }
                        }
                    },
                    plugins: {
                        zoom: {
                            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' },
                            pan: { enabled: true, mode: 'xy' }
                        }
                    }
                }
            });

            // 初始化下方图表
            const bottomCtx = elements.bottomChartCanvas.getContext('2d');
            bottomChart = new Chart(bottomCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '频域分析',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    layout: {
                        padding: {
                            top: 10,
                            right: 10,
                            bottom: 10,
                            left: 10
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '频率 (Hz)',
                                font: { size: 12, weight: 'bold' }
                            },
                            type: 'linear',
                            ticks: {
                                maxTicksLimit: 10,
                                callback: function(value) {
                                    return value + ' Hz';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '幅值',
                                font: { size: 12, weight: 'bold' }
                            },
                            ticks: {
                                maxTicksLimit: 8,
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        zoom: {
                            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' },
                            pan: { enabled: true, mode: 'xy' }
                        }
                    }
                }
            });

            // 监听窗口大小变化，调整图表大小
            window.addEventListener('resize', () => {
                setTimeout(() => {
                    if (topChart) {
                        topChart.resize();
                    }
                    if (bottomChart) {
                        bottomChart.resize();
                    }
                }, 100);
            });

            // 使用ResizeObserver监听图表容器大小变化
            if (window.ResizeObserver) {
                const resizeObserver = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        setTimeout(() => {
                            if (entry.target.id === 'topChartCanvas' && topChart) {
                                topChart.resize();
                            } else if (entry.target.id === 'bottomChartCanvas' && bottomChart) {
                                bottomChart.resize();
                            }
                        }, 50);
                    }
                });

                if (elements.topChartCanvas) {
                    resizeObserver.observe(elements.topChartCanvas);
                }
                if (elements.bottomChartCanvas) {
                    resizeObserver.observe(elements.bottomChartCanvas);
                }
            }
        }

        // 更新图表
        function updateCharts() {
            if (receivedData.length === 0) return;

            // 隐藏占位符，显示图表
            if (elements.topChartPlaceholder && elements.bottomChartPlaceholder) {
                elements.topChartPlaceholder.style.display = 'none';
                elements.bottomChartPlaceholder.style.display = 'none';
                elements.topChartCanvas.style.display = 'block';
                elements.bottomChartCanvas.style.display = 'block';
            }

            // 更新上方图表
            updateTopChart();

            // 更新下方图表
            updateBottomChart();
        }

        // 更新上方图表
        function updateTopChart() {
            if (!topChart) {
                console.log('上方图表不存在，跳过更新');
                return;
            }

            console.log('更新上方图表，类型:', currentTopChartType, '数据长度:', receivedData.length);

            switch (currentTopChartType) {
                case 'time':
                    updateTimeChart(topChart, receivedData);
                    break;
                case 'frequency':
                    updateFrequencyChart(topChart, receivedData);
                    break;
                case 'envelope':
                    updateEnvelopeChart(topChart, receivedData);
                    break;
                case 'phase':
                    updatePhaseChart(topChart, receivedData);
                    break;
                case 'cdf':
                    updateCDFChart(topChart, receivedData);
                    break;
                case 'psd':
                    updatePSDChart(topChart, receivedData);
                    break;
                case 'vector':
                    updateVectorChart(topChart, receivedData);
                    break;
                case 'polar':
                    updatePolarChart(topChart, receivedData);
                    break;
                case 'wavelet':
                    updateWaveletChart(topChart, receivedData);
                    break;
            }
        }

        // 更新下方图表
        function updateBottomChart() {
            if (!bottomChart) {
                console.log('下方图表不存在，跳过更新');
                return;
            }

            console.log('更新下方图表，类型:', currentBottomChartType, '数据长度:', receivedData.length);

            switch (currentBottomChartType) {
                case 'time':
                    updateTimeChart(bottomChart, receivedData);
                    break;
                case 'frequency':
                    updateFrequencyChart(bottomChart, receivedData);
                    break;
                case 'envelope':
                    updateEnvelopeChart(bottomChart, receivedData);
                    break;
                case 'phase':
                    updatePhaseChart(bottomChart, receivedData);
                    break;
                case 'cdf':
                    updateCDFChart(bottomChart, receivedData);
                    break;
                case 'psd':
                    updatePSDChart(bottomChart, receivedData);
                    break;
                case 'vector':
                    updateVectorChart(bottomChart, receivedData);
                    break;
                case 'polar':
                    updatePolarChart(bottomChart, receivedData);
                    break;
                case 'wavelet':
                    updateWaveletChart(bottomChart, receivedData);
                    break;
            }
        }

        // 更新时域图表
        function updateTimeChart(chart, data) {
            const sampleRate = 100; // Hz
            const timeData = data.map((value, index) => ({
                x: (index / sampleRate).toFixed(3), // 时间轴，保留3位小数
                y: value
            }));

            chart.data.datasets[0].data = timeData;
            chart.data.datasets[0].label = '时域波形';

            // 更新坐标轴配置
            chart.options.scales.x.title.text = '时间 (秒)';
            chart.options.scales.y.title.text = '幅值';
            chart.options.scales.x.type = 'linear';
            chart.options.scales.x.ticks = {
                maxTicksLimit: 10,
                callback: function(value) {
                    return value.toFixed(2) + 's';
                }
            };
            chart.options.scales.y.ticks = {
                maxTicksLimit: 8,
                callback: function(value) {
                    return parseFloat(value.toFixed(3));
                }
            };

            chart.update('none');
        }

        // 更新频域图表
        function updateFrequencyChart(chart, data) {
            const fftData = performSimpleFFT(data);
            const sampleRate = 1000; // Hz
            const freqData = fftData.map((value, index) => ({
                x: (index * sampleRate / fftData.length).toFixed(1),
                y: value
            }));

            chart.data.datasets[0].data = freqData;
            chart.data.datasets[0].label = '频域分析';

            // 更新坐标轴配置
            chart.options.scales.x.title.text = '频率 (Hz)';
            chart.options.scales.y.title.text = '幅值';
            chart.options.scales.x.type = 'linear';
            chart.options.scales.x.ticks = {
                maxTicksLimit: 10,
                callback: function(value) {
                    return value + ' Hz';
                }
            };
            chart.options.scales.y.ticks = {
                maxTicksLimit: 8,
                callback: function(value) {
                    return parseFloat(value.toFixed(3));
                }
            };

            chart.update('none');
        }

        // 简单FFT近似
        function performSimpleFFT(data) {
            const N = Math.min(data.length, 256);
            const result = new Array(N / 2);

            for (let k = 0; k < N / 2; k++) {
                let real = 0, imag = 0;
                for (let n = 0; n < N; n++) {
                    const angle = -2 * Math.PI * k * n / N;
                    real += data[n] * Math.cos(angle);
                    imag += data[n] * Math.sin(angle);
                }
                result[k] = Math.sqrt(real * real + imag * imag);
            }

            return result;
        }

        // 更新包络图表
        function updateEnvelopeChart(chart, data) {
            const envelopeData = calculateEnvelope(data);
            const sampleRate = 100; // Hz
            const timeData = envelopeData.map((value, index) => ({
                x: (index / sampleRate).toFixed(3),
                y: value
            }));

            chart.data.datasets[0].data = timeData;
            chart.data.datasets[0].label = '包络线图';

            // 更新坐标轴配置
            chart.options.scales.x.title.text = '时间 (秒)';
            chart.options.scales.y.title.text = '包络值';
            chart.options.scales.x.type = 'linear';
            chart.options.scales.x.ticks = {
                maxTicksLimit: 10,
                callback: function(value) {
                    return value.toFixed(2) + 's';
                }
            };
            chart.options.scales.y.ticks = {
                maxTicksLimit: 8,
                callback: function(value) {
                    return parseFloat(value.toFixed(3));
                }
            };

            chart.update('none');
        }

        // 更新瞬时相位图表
        function updatePhaseChart(chart, data) {
            const phaseData = calculateInstantaneousPhase(data);
            const sampleRate = 100; // Hz
            const timeData = phaseData.map((value, index) => ({
                x: (index / sampleRate).toFixed(3),
                y: value
            }));

            chart.data.datasets[0].data = timeData;
            chart.data.datasets[0].label = '瞬时相位';

            // 更新坐标轴配置
            chart.options.scales.x.title.text = '时间 (秒)';
            chart.options.scales.y.title.text = '相位 (弧度)';
            chart.options.scales.x.type = 'linear';
            chart.options.scales.x.ticks = {
                maxTicksLimit: 10,
                callback: function(value) {
                    return value.toFixed(2) + 's';
                }
            };
            chart.options.scales.y.ticks = {
                maxTicksLimit: 8,
                callback: function(value) {
                    return parseFloat(value.toFixed(3)) + 'π';
                }
            };

            chart.update('none');
        }

        // 更新累积分布函数图表
        function updateCDFChart(chart, data) {
            const cdfData = calculateCDF(data);

            chart.data.datasets[0].data = cdfData;
            chart.data.datasets[0].label = '累积分布函数';

            // 更新坐标轴配置
            chart.options.scales.x.title.text = '数值';
            chart.options.scales.y.title.text = '累积概率';
            chart.options.scales.x.type = 'linear';
            chart.options.scales.x.ticks = {
                maxTicksLimit: 10,
                callback: function(value) {
                    return value.toFixed(1);
                }
            };
            chart.options.scales.y.ticks = {
                maxTicksLimit: 8,
                callback: function(value) {
                    return parseFloat((value * 100).toFixed(3)) + '%';
                }
            };

            chart.update('none');
        }

        // 更新功率谱密度图表
        function updatePSDChart(chart, data) {
            const psdData = calculatePSD(data);

            chart.data.datasets[0].data = psdData;
            chart.data.datasets[0].label = '功率谱密度';

            // 更新坐标轴配置
            chart.options.scales.x.title.text = '频率 (Hz)';
            chart.options.scales.y.title.text = '功率密度 (dB/Hz)';
            chart.options.scales.x.type = 'linear';
            chart.options.scales.x.ticks = {
                maxTicksLimit: 10,
                callback: function(value) {
                    return value + ' Hz';
                }
            };
            chart.options.scales.y.ticks = {
                maxTicksLimit: 8,
                callback: function(value) {
                    return parseFloat(value.toFixed(3)) + ' dB';
                }
            };

            chart.update('none');
        }

        // 计算包络
        function calculateEnvelope(data) {
            const windowSize = Math.max(5, Math.floor(data.length / 100));
            const envelope = [];

            for (let i = 0; i < data.length; i++) {
                let max = -Infinity;
                const start = Math.max(0, i - windowSize / 2);
                const end = Math.min(data.length, i + windowSize / 2);

                for (let j = start; j < end; j++) {
                    max = Math.max(max, Math.abs(data[j]));
                }
                envelope.push(max);
            }

            return envelope;
        }

        // 计算瞬时相位
        function calculateInstantaneousPhase(data) {
            const phaseData = [];

            for (let i = 1; i < data.length; i++) {
                const dy = data[i] - data[i-1];
                const dx = 1; // 假设采样间隔为1
                const phase = Math.atan2(dy, dx);
                phaseData.push(phase);
            }

            return phaseData;
        }

        // 计算累积分布函数
        function calculateCDF(data) {
            const sortedData = [...data].sort((a, b) => a - b);
            const cdfData = [];

            sortedData.forEach((value, index) => {
                cdfData.push({
                    x: value,
                    y: (index + 1) / sortedData.length
                });
            });

            return cdfData;
        }

        // 计算功率谱密度
        function calculatePSD(data) {
            const fftData = performSimpleFFT(data);
            const psdData = fftData.map((value, index) => ({
                x: index * 1000 / fftData.length,
                y: value * value / data.length // 简化的PSD计算
            }));

            return psdData;
        }

        // 更新矢量图表
        function updateVectorChart(chart, data) {
            const vectorData = calculateVectorData(data);

            chart.data.datasets[0].data = vectorData;
            chart.data.datasets[0].label = '矢量图';

            // 更新坐标轴配置
            chart.options.scales.x.title.text = 'X 分量';
            chart.options.scales.y.title.text = 'Y 分量';
            chart.options.scales.x.type = 'linear';
            chart.options.scales.x.ticks = {
                maxTicksLimit: 10,
                callback: function(value) {
                    return value.toFixed(1);
                }
            };
            chart.options.scales.y.ticks = {
                maxTicksLimit: 8,
                callback: function(value) {
                    return parseFloat(value.toFixed(3));
                }
            };

            chart.update('none');
        }

        // 更新极坐标图表
        function updatePolarChart(chart, data) {
            if (!chart || chart.config.type !== 'polarArea') return chart;

            const polarData = calculatePolarData(data);
            console.log('极坐标数据:', polarData); // 调试信息

            chart.data.labels = polarData.labels;
            chart.data.datasets[0].data = polarData.values;
            chart.data.datasets[0].backgroundColor = polarData.colors;
            chart.data.datasets[0].borderColor = polarData.colors.map(color => color.replace('0.6', '1'));
            chart.update('none');

            return chart;
        }

        // 更新小波变换图表
        function updateWaveletChart(chart, data) {
            const waveletData = calculateWaveletData(data);

            chart.data.datasets[0].data = waveletData;
            chart.data.datasets[0].label = '小波变换';

            // 更新坐标轴配置
            chart.options.scales.x.title.text = '时间 (秒)';
            chart.options.scales.y.title.text = '小波系数';
            chart.options.scales.x.type = 'linear';
            chart.options.scales.x.ticks = {
                maxTicksLimit: 10,
                callback: function(value) {
                    return value.toFixed(2) + 's';
                }
            };
            chart.options.scales.y.ticks = {
                maxTicksLimit: 8,
                callback: function(value) {
                    return parseFloat(value.toFixed(3));
                }
            };

            chart.update('none');
        }

        // 计算矢量数据
        function calculateVectorData(data) {
            const vectorData = [];
            const step = Math.max(1, Math.floor(data.length / 100)); // 限制点数

            for (let i = 0; i < data.length - 1; i += step) {
                const x = data[i];
                const y = data[i + 1] || 0;
                vectorData.push({ x: x, y: y });
            }

            return vectorData;
        }

        // 计算极坐标数据
        function calculatePolarData(data) {
            const bins = 16; // 极坐标分段数
            const values = new Array(bins).fill(0);
            const labels = [];
            const colors = [];

            // 生成标签和颜色
            for (let i = 0; i < bins; i++) {
                const angle = (i * 360 / bins).toFixed(0);
                labels.push(`${angle}°`);
                const hue = i * 360 / bins;
                colors.push(`hsla(${hue}, 70%, 60%, 0.6)`);
            }

            // 将数据映射到极坐标
            data.forEach(value => {
                const normalized = (value + 1) / 2; // 归一化到[0,1]
                const binIndex = Math.floor(normalized * bins) % bins;
                values[binIndex] += Math.abs(value);
            });

            return { labels, values, colors };
        }

        // 计算小波变换数据（简化版）
        function calculateWaveletData(data) {
            const waveletData = [];
            const windowSize = 16; // 小波窗口大小

            for (let i = 0; i < data.length - windowSize; i++) {
                let sum = 0;
                for (let j = 0; j < windowSize; j++) {
                    // 简化的Haar小波变换
                    const weight = j < windowSize / 2 ? 1 : -1;
                    sum += data[i + j] * weight;
                }

                waveletData.push({
                    x: i * 0.01,
                    y: sum / windowSize
                });
            }

            return waveletData;
        }

        // 切换上方图表类型
        function switchTopChartType(type) {
            console.log('切换上方图表类型到:', type);
            currentTopChartType = type;

            // 更新图表标题和图标
            const titles = {
                time: '时域波形',
                frequency: '频域分析',
                envelope: '包络线图',
                phase: '瞬时相位',
                cdf: '累积分布函数',
                psd: '功率谱密度',
                vector: '矢量图',
                polar: '极坐标图',
                wavelet: '小波变换图'
            };

            const icons = {
                time: 'fas fa-wave-square',
                frequency: 'fas fa-chart-area',
                envelope: 'fas fa-mountain',
                phase: 'fas fa-sync-alt',
                cdf: 'fas fa-chart-line',
                psd: 'fas fa-chart-bar',
                vector: 'fas fa-arrows-alt',
                polar: 'fas fa-circle-notch',
                wavelet: 'fas fa-water'
            };

            if (elements.topChartTitle) {
                elements.topChartTitle.textContent = titles[type];
            }
            if (elements.topChartIcon) {
                elements.topChartIcon.className = icons[type];
            }

            // 重新创建图表
            recreateTopChart();
        }

        // 切换下方图表类型
        function switchBottomChartType(type) {
            console.log('切换下方图表类型到:', type);
            currentBottomChartType = type;

            // 更新图表标题和图标
            const titles = {
                time: '时域波形',
                frequency: '频域分析',
                envelope: '包络线图',
                phase: '瞬时相位',
                cdf: '累积分布函数',
                psd: '功率谱密度',
                vector: '矢量图',
                polar: '极坐标图',
                wavelet: '小波变换图'
            };

            const icons = {
                time: 'fas fa-wave-square',
                frequency: 'fas fa-chart-area',
                envelope: 'fas fa-mountain',
                phase: 'fas fa-sync-alt',
                cdf: 'fas fa-chart-line',
                psd: 'fas fa-chart-bar',
                vector: 'fas fa-arrows-alt',
                polar: 'fas fa-circle-notch',
                wavelet: 'fas fa-water'
            };

            if (elements.bottomChartTitle) {
                elements.bottomChartTitle.textContent = titles[type];
            }
            if (elements.bottomChartIcon) {
                elements.bottomChartIcon.className = icons[type];
            }

            // 重新创建图表
            recreateBottomChart();
        }

        // 重新创建上方图表
        function recreateTopChart() {
            console.log('开始重新创建上方图表，类型:', currentTopChartType);

            // 销毁现有图表
            if (topChart) {
                console.log('销毁现有上方图表');
                topChart.destroy();
                topChart = null;
            }

            const ctx = elements.topChartCanvas.getContext('2d');
            if (!ctx) {
                console.error('无法获取上方图表canvas context');
                return;
            }

            // 根据图表类型创建相应的图表
            if (currentTopChartType === 'polar') {
                topChart = new Chart(ctx, {
                    type: 'polarArea',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '极坐标图',
                            data: [],
                            backgroundColor: [],
                            borderColor: [],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 0 }
                    }
                });
            } else {
                topChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '数据',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 0 },
                        scales: {
                            x: { title: { display: true, text: '时间 (秒)' }, type: 'linear' },
                            y: { title: { display: true, text: '幅值' } }
                        }
                    }
                });
            }

            // 立即更新图表数据
            console.log('上方图表已重新创建，类型:', currentTopChartType);
            updateTopChart();
        }

        // 重新创建下方图表
        function recreateBottomChart() {
            console.log('开始重新创建下方图表，类型:', currentBottomChartType);

            // 销毁现有图表
            if (bottomChart) {
                console.log('销毁现有下方图表');
                bottomChart.destroy();
                bottomChart = null;
            }

            const ctx = elements.bottomChartCanvas.getContext('2d');
            if (!ctx) {
                console.error('无法获取下方图表canvas context');
                return;
            }

            // 根据图表类型创建相应的图表
            if (currentBottomChartType === 'polar') {
                bottomChart = new Chart(ctx, {
                    type: 'polarArea',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '极坐标图',
                            data: [],
                            backgroundColor: [],
                            borderColor: [],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 0 }
                    }
                });
            } else {
                bottomChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '数据',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 0 },
                        scales: {
                            x: { title: { display: true, text: '频率 (Hz)' }, type: 'linear' },
                            y: { title: { display: true, text: '幅值' } }
                        }
                    }
                });
            }

            // 立即更新图表数据
            console.log('下方图表已重新创建，类型:', currentBottomChartType);
            updateBottomChart();
        }

        // 显示消息提示
        function showMessage(message, type = 'info') {
            // 创建消息元素
            const messageEl = document.createElement('div');
            messageEl.className = `message-toast message-${type}`;
            messageEl.textContent = message;

            // 添加样式
            messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-size: 14px;
                max-width: 300px;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;

            document.body.appendChild(messageEl);

            // 显示动画
            setTimeout(() => {
                messageEl.style.opacity = '1';
                messageEl.style.transform = 'translateX(0)';
            }, 100);

            // 自动隐藏
            setTimeout(() => {
                messageEl.style.opacity = '0';
                messageEl.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.parentNode.removeChild(messageEl);
                    }
                }, 300);
            }, 3000);
        }

        // 事件监听器
        function setupEventListeners() {
            // 连接事件（使用统一的连接/断开函数）
            elements.connectBtn.addEventListener('click', connect);
            elements.disconnectBtn.addEventListener('click', disconnect);

            // 初始化连接类型选择器
            initConnectionTypeTabs();

            // 串口选择事件
            const selectPortBtn = document.getElementById('selectPortBtn');
            if (selectPortBtn) {
                selectPortBtn.addEventListener('click', selectPort);
            }

            elements.portSelect.addEventListener('change', async (e) => {
                if (e.target.value === '') {
                    await selectPort();
                }
            });

            // 蓝牙扫描事件
            if (elements.scanBluetoothBtn) {
                elements.scanBluetoothBtn.addEventListener('click', scanBluetoothDevices);
            }

            // 监视器控制事件
            elements.clearMonitorBtn.addEventListener('click', () => {
                elements.monitorDisplay.innerHTML = '<div class="monitor-placeholder"><i class="fas fa-terminal"></i><p>监视器已清空</p></div>';
            });

            elements.pauseMonitorBtn.addEventListener('click', (e) => {
                reading = !reading;
                if (reading) {
                    e.target.innerHTML = '<i class="fas fa-pause"></i> 暂停';
                    elements.monitorStatus.innerHTML = '<span class="status-badge receiving">接收中</span>';
                    if (connected) startReading();
                } else {
                    e.target.innerHTML = '<i class="fas fa-play"></i> 继续';
                    elements.monitorStatus.innerHTML = '<span class="status-badge paused">已暂停</span>';
                }
            });

            // 数据发送事件
            elements.sendOnceBtn.addEventListener('click', async () => {
                const data = elements.sendDataInput.value.trim();
                const format = elements.sendFormatSelect.value;
                if (data) {
                    await sendData(data, format);
                }
            });

            elements.sendRepeatBtn.addEventListener('click', () => {
                const data = elements.sendDataInput.value.trim();
                const format = elements.sendFormatSelect.value;
                const interval = parseInt(elements.sendIntervalInput.value);

                if (!data) {
                    alert('请输入要发送的数据');
                    return;
                }

                if (sendInterval) {
                    stopSendInterval();
                } else {
                    sendInterval = setInterval(async () => {
                        await sendData(data, format);
                    }, interval);
                    elements.sendRepeatBtn.innerHTML = '<i class="fas fa-stop"></i> 停止发送';
                }
            });

            // 快速发送按钮事件
            document.querySelectorAll('.quick-send-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    elements.sendDataInput.value = btn.dataset.value;
                });
            });

            // 协议选择事件
            elements.protocolSelect.addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    elements.protocolConfig.style.display = 'block';
                } else {
                    elements.protocolConfig.style.display = 'none';
                }
            });

            // 统计重置事件
            elements.resetStatsBtn.addEventListener('click', () => {
                statistics = {
                    receivedBytes: 0,
                    sentBytes: 0,
                    packets: 0,
                    connectionStartTime: connected ? Date.now() : null,
                    errors: 0
                };
                updateStatistics();
            });

            // 导出统计报告事件
            elements.exportStatsBtn.addEventListener('click', () => {
                const timestamp = new Date().toLocaleString('zh-CN');
                const reportText = `串口调试统计报告
=====================================

生成时间: ${timestamp}

连接信息:
---------
波特率: ${elements.baudRateSelect.value}
数据位: ${elements.dataBitsSelect.value}
停止位: ${elements.stopBitsSelect.value}

统计数据:
---------
数据包总数: ${statistics.packets}
发送字节数: ${statistics.sentBytes}
接收字节数: ${statistics.receivedBytes}
错误数量: ${statistics.errors}
连接时长: ${statistics.connectionStartTime ? Math.floor((Date.now() - statistics.connectionStartTime) / 1000) : 0}秒
传输速率: ${statistics.connectionStartTime ? ((statistics.sentBytes + statistics.receivedBytes) / ((Date.now() - statistics.connectionStartTime) / 1000)).toFixed(2) : 0} bytes/s
错误率: ${statistics.packets > 0 ? (statistics.errors / statistics.packets * 100).toFixed(2) : 0}%

报告结束
=====================================`;

                const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `串口调试报告_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            });

            // 图表类型切换事件
            if (elements.topChartTypeSelect) {
                elements.topChartTypeSelect.addEventListener('change', (e) => {
                    switchTopChartType(e.target.value);
                });
            }

            if (elements.bottomChartTypeSelect) {
                elements.bottomChartTypeSelect.addEventListener('change', (e) => {
                    switchBottomChartType(e.target.value);
                });
            }

            // 图表操作事件
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;
                    const chartType = btn.dataset.chart;
                    handleChartAction(action, chartType);
                });
            });

            // 刷新图表事件
            if (elements.refreshChartsBtn) {
                elements.refreshChartsBtn.addEventListener('click', () => {
                    // 重新初始化图表
                    if (topChart) {
                        topChart.destroy();
                        topChart = null;
                    }
                    if (bottomChart) {
                        bottomChart.destroy();
                        bottomChart = null;
                    }

                    // 清空数据
                    receivedData = [];

                    // 重新创建图表
                    initializeCharts();

                    // 显示成功消息
                    showMessage('图表已刷新', 'success');
                });
            }

            // 导出全部事件
            if (elements.exportAllBtn) {
                elements.exportAllBtn.addEventListener('click', () => {
                    // 导出上方图表
                    if (topChart) {
                        exportChart('png', 'top');
                        setTimeout(() => exportChartData('top'), 500);
                    }

                    // 导出下方图表
                    if (bottomChart) {
                        setTimeout(() => {
                            exportChart('png', 'bottom');
                            setTimeout(() => exportChartData('bottom'), 500);
                        }, 1000);
                    }

                    // 显示成功消息
                    showMessage('正在导出所有图表数据...', 'info');
                });
            }

            // 导航菜单事件
            document.querySelectorAll('.category-header').forEach(header => {
                header.addEventListener('click', () => {
                    const category = header.closest('.nav-category');
                    category.classList.toggle('expanded');
                    header.classList.toggle('expanded');
                });
            });
        }

        // 处理图表操作
        function handleChartAction(action, chartType) {
            const chart = chartType === 'top' ? topChart : bottomChart;
            if (!chart) return;

            switch (action) {
                case 'zoom-x-in':
                    chart.zoom({ x: 1.1 });
                    break;
                case 'zoom-x-out':
                    chart.zoom({ x: 0.9 });
                    break;
                case 'zoom-y-in':
                    chart.zoom({ y: 1.1 });
                    break;
                case 'zoom-y-out':
                    chart.zoom({ y: 0.9 });
                    break;
                case 'reset':
                    chart.resetZoom();
                    break;
                case 'export-png':
                    exportChart('png', chartType);
                    break;
                case 'export-jpg':
                    exportChart('jpg', chartType);
                    break;
                case 'export-excel':
                    exportChartData(chartType);
                    break;
                case 'fullscreen':
                    toggleFullscreen(chartType);
                    break;
            }
        }

        // 导出图表
        function exportChart(format, chartType) {
            const chart = chartType === 'top' ? topChart : bottomChart;
            const chartTypeName = chartType === 'top' ? currentTopChartType : currentBottomChartType;

            if (!chart) return;

            const canvas = chart.canvas;
            const url = canvas.toDataURL(`image/${format}`);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chart_${chartType}_${chartTypeName}_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.${format}`;
            a.click();
        }

        // 导出图表数据
        function exportChartData(chartType) {
            if (receivedData.length === 0) {
                alert('没有数据可导出');
                return;
            }

            const chartTypeName = chartType === 'top' ? currentTopChartType : currentBottomChartType;
            const wb = XLSX.utils.book_new();

            let sheetData = [['时间点', '数值']];

            // 根据图表类型导出相应数据
            switch (chartTypeName) {
                case 'time':
                    sheetData = [['时间(s)', '幅值'], ...receivedData.map((value, index) => [index * 0.01, value])];
                    break;
                case 'frequency':
                    const fftData = performSimpleFFT(receivedData);
                    sheetData = [['频率(Hz)', '幅值'], ...fftData.map((value, index) => [index * 1000 / fftData.length, value])];
                    break;
                case 'envelope':
                    const envelopeData = calculateEnvelope(receivedData);
                    sheetData = [['时间(s)', '包络值'], ...envelopeData.map((value, index) => [index * 0.01, value])];
                    break;
                case 'phase':
                    const phaseData = calculateInstantaneousPhase(receivedData);
                    sheetData = [['时间(s)', '相位(弧度)'], ...phaseData.map((value, index) => [index * 0.01, value])];
                    break;
                case 'cdf':
                    const cdfData = calculateCDF(receivedData);
                    sheetData = [['数值', '累积概率'], ...cdfData.map(point => [point.x, point.y])];
                    break;
                case 'psd':
                    const psdData = calculatePSD(receivedData);
                    sheetData = [['频率(Hz)', 'PSD'], ...psdData.map(point => [point.x, point.y])];
                    break;
                case 'vector':
                    const vectorData = calculateVectorData(receivedData);
                    sheetData = [['X分量', 'Y分量'], ...vectorData.map(point => [point.x, point.y])];
                    break;
                case 'polar':
                    const polarData = calculatePolarData(receivedData);
                    sheetData = [['角度', '幅值'], ...polarData.labels.map((label, index) => [label, polarData.values[index]])];
                    break;
                case 'wavelet':
                    const waveletData = calculateWaveletData(receivedData);
                    sheetData = [['时间(s)', '小波系数'], ...waveletData.map(point => [point.x, point.y])];
                    break;
                default:
                    sheetData = [['时间点', '数值'], ...receivedData.map((value, index) => [index, value])];
            }

            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            XLSX.utils.book_append_sheet(wb, ws, `${chartType}_${chartTypeName}`);
            XLSX.writeFile(wb, `serial_${chartType}_${chartTypeName}_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`);
        }

        // 切换全屏
        function toggleFullscreen(chartType) {
            const chartContainer = chartType === 'top' ?
                document.getElementById('topChartCard') :
                document.getElementById('bottomChartCard');

            if (!document.fullscreenElement) {
                chartContainer.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // 创建粒子效果
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 50;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // 同步控制面板高度
        function syncPanelHeights() {
            const visualizationArea = document.querySelector('.visualization-area');
            const controlPanel = document.querySelector('.control-panel');

            if (visualizationArea && controlPanel) {
                const visualHeight = visualizationArea.offsetHeight;
                controlPanel.style.height = visualHeight + 'px';
                controlPanel.style.maxHeight = visualHeight + 'px';
            }
        }

        // 页面初始化
        function initializePage() {
            // 创建粒子效果
            createParticles();

            // 设置事件监听器
            setupEventListeners();

            // 初始化图表
            initCharts();

            // 更新串口列表
            updatePortList();

            // 显示图表占位符
            elements.topChartPlaceholder.style.display = 'block';
            elements.bottomChartPlaceholder.style.display = 'block';
            elements.topChartCanvas.style.display = 'none';
            elements.bottomChartCanvas.style.display = 'none';

            // 定时更新统计信息（仅在连接时更新时长）
            setInterval(() => {
                if (connected && statistics.connectionStartTime) {
                    updateStatistics();
                }
            }, 1000);

            // 添加测试数据按钮（仅用于演示）
            addTestDataButton();

            // 同步面板高度
            setTimeout(() => {
                syncPanelHeights();
                // 监听窗口大小变化
                window.addEventListener('resize', syncPanelHeights);
            }, 100);

            console.log('串口调试平台初始化完成');
        }

        // 添加测试数据按钮（用于演示）
        function addTestDataButton() {
            const testBtn = document.createElement('button');
            testBtn.className = 'btn btn-outline btn-small';
            testBtn.innerHTML = '<i class="fas fa-vial"></i> 生成测试数据';
            testBtn.style.marginLeft = '10px';

            testBtn.addEventListener('click', () => {
                generateTestData();
            });

            const visualizationActions = document.querySelector('.visualization-actions');
            if (visualizationActions) {
                visualizationActions.appendChild(testBtn);
            }
        }

        // 生成测试数据
        function generateTestData() {
            // 停止任何正在运行的模拟连接
            if (connected) {
                connected = false;
                updateConnectionStatus(false);
            }

            // 清空现有数据
            receivedData = [];

            // 确保图表已初始化
            if (!topChart || !bottomChart) {
                initCharts();
            }

            // 生成模拟的正弦波数据
            const testData = [];
            const frequency = 2; // Hz
            const amplitude = 100;
            const sampleRate = 100; // samples per second
            const duration = 3; // seconds
            const maxDataPoints = 300; // 限制最大数据点数

            for (let i = 0; i < Math.min(duration * sampleRate, maxDataPoints); i++) {
                const t = i / sampleRate;
                const value = amplitude * Math.sin(2 * Math.PI * frequency * t) +
                             20 * Math.sin(2 * Math.PI * frequency * 5 * t) +
                             Math.random() * 10 - 5; // 添加一些噪声
                testData.push(value);
            }

            // 模拟接收数据
            receivedData = testData.slice(0, maxDataPoints);
            statistics.receivedBytes += receivedData.length * 4;
            statistics.packets += receivedData.length;

            // 显示在监视器中
            const hexData = testData.slice(0, 10).map(v =>
                Math.round(v).toString(16).toUpperCase().padStart(2, '0')
            ).join(' ') + '...';
            displayInMonitor(hexData, 'received');

            // 显示图表
            if (elements.topChartPlaceholder) {
                elements.topChartPlaceholder.style.display = 'none';
            }
            if (elements.bottomChartPlaceholder) {
                elements.bottomChartPlaceholder.style.display = 'none';
            }
            if (elements.topChartCanvas) {
                elements.topChartCanvas.style.display = 'block';
            }
            if (elements.bottomChartCanvas) {
                elements.bottomChartCanvas.style.display = 'block';
            }

            // 延迟更新图表，确保DOM已更新
            setTimeout(() => {
                // 强制重新计算图表大小
                if (topChart) {
                    topChart.resize();
                    topChart.update('none');
                }
                if (bottomChart) {
                    bottomChart.resize();
                    bottomChart.update('none');
                }
                updateCharts();
                updateStatistics();
            }, 200);

            console.log('测试数据已生成:', testData.length, '个数据点');
        }

        // 模拟连接状态（用于演示）
        function simulateConnection() {
            if (!connected) {
                connected = true;
                statistics.connectionStartTime = Date.now();
                updateConnectionStatus(true);

                // 模拟定期接收数据
                const dataInterval = setInterval(() => {
                    if (!connected) {
                        clearInterval(dataInterval);
                        return;
                    }

                    // 生成随机数据点
                    const newValue = 50 + 30 * Math.sin(Date.now() / 1000) + Math.random() * 20 - 10;
                    receivedData.push(newValue);

                    if (receivedData.length > 1000) {
                        receivedData = receivedData.slice(-1000);
                    }

                    statistics.receivedBytes += 4;
                    statistics.packets++;

                    // 显示图表
                    if (elements.topChartPlaceholder.style.display !== 'none') {
                        elements.topChartPlaceholder.style.display = 'none';
                        elements.bottomChartPlaceholder.style.display = 'none';
                        elements.topChartCanvas.style.display = 'block';
                        elements.bottomChartCanvas.style.display = 'block';
                    }

                    updateCharts();
                }, 100); // 每100ms更新一次
            }
        }

        // 全局变量用于控制页面初始化
        let librariesLoaded = false;
        let domReady = false;

        // 页面加载完成后初始化（已在上面的DOMContentLoaded中处理）

        // 检查是否可以初始化页面
        function checkReadyAndInitialize() {
            if (domReady && librariesLoaded) {
                initializePage();

                // 隐藏加载动画
                const loader = document.getElementById('pageLoader');
                if (loader) {
                    loader.classList.add('loaded');

                    // 完全移除加载器
                    setTimeout(() => {
                        loader.remove();
                    }, 600);
                }
            }
        }
    </script>
</body>
</html>