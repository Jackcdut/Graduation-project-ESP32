# 示波器游标功能快速测试指南

## 测试目标

验证示波器的游标测量功能（Cursor Measurement）在时域和频域模式下都能正常工作。

## 测试前准备

1. **编译并烧录固件**
   ```bash
   idf.py build flash monitor
   ```

2. **进入示波器界面**
   - 启动设备
   - 从主菜单进入示波器功能

## 测试步骤

### 测试1：游标模式切换

**目的**: 验证三种模式的切换和视觉效果

1. 点击右侧"Cursor"按钮
2. 观察按钮边框变为青色（#00FFFF），标签显示"H-CUR"
3. 观察波形区域出现青色虚线垂直线，位于中心位置
4. 再次点击"Cursor"按钮
5. 观察按钮边框变为黄色（#FFFF00），标签显示"V-CUR"
6. 观察波形区域出现黄色虚线水平线，位于中心位置
7. 再次点击"Cursor"按钮
8. 观察游标线消失，按钮恢复紫色边框，标签显示"OFF"

**预期结果**:
- ✅ 模式循环切换正常：OFF → H-CUR → V-CUR → OFF
- ✅ 按钮边框颜色正确变化
- ✅ 游标线样式为虚线（8px实线 + 4px间隔）
- ✅ 游标线有发光效果
- ✅ 标签背景半透明，带边框和圆角

### 测试2：横轴游标（时域模式）

**目的**: 验证时间测量功能

1. 确保示波器处于时域模式（非FFT）
2. 点击"Cursor"按钮切换到"H-CUR"模式
3. 在波形区域左右拖动手指
4. 观察青色垂直线跟随移动
5. 观察标签实时显示时间值（如"1.25ms"）
6. 拖动到最左边，观察时间值接近0
7. 拖动到最右边，观察时间值接近总时间
8. 改变时间刻度（Time/Div），观察测量值相应变化

**预期结果**:
- ✅ 游标线流畅跟随触摸位置
- ✅ 时间值实时更新
- ✅ 单位自动转换（s/ms/μs/ns）
- ✅ 标签位置智能调整（接近右边界时移到左侧）
- ✅ 时间值范围正确（0 到 总时间）

### 测试3：纵轴游标（时域模式）

**目的**: 验证电压测量功能

1. 确保示波器处于时域模式
2. 点击"Cursor"按钮切换到"V-CUR"模式
3. 在波形区域上下拖动手指
4. 观察黄色水平线跟随移动
5. 观察标签实时显示电压值（如"1.650V"）
6. 拖动到最上方，观察电压值为正值
7. 拖动到中心，观察电压值接近0V
8. 拖动到最下方，观察电压值为负值
9. 改变电压刻度（V/Div），观察测量值相应变化

**预期结果**:
- ✅ 游标线流畅跟随触摸位置
- ✅ 电压值实时更新
- ✅ 显示3位小数精度
- ✅ 标签位置智能调整（接近上边界时移到下方）
- ✅ 电压值范围正确（根据V/Div计算）

### 测试4：横轴游标（FFT模式）

**目的**: 验证频率测量功能

1. 点击"FFT"按钮切换到频域模式
2. 点击"Cursor"按钮切换到"H-CUR"模式
3. 在波形区域左右拖动手指
4. 观察青色垂直线跟随移动
5. 观察标签实时显示频率值（如"2.50kHz"）
6. 拖动到最左边，观察频率值接近0Hz
7. 拖动到最右边，观察频率值接近最大频率
8. 改变频率范围，观察测量值相应变化

**预期结果**:
- ✅ 游标线流畅跟随触摸位置
- ✅ 频率值实时更新
- ✅ 单位自动转换（Hz/kHz/MHz）
- ✅ 频率值范围正确（0 到 最大频率）

### 测试5：纵轴游标（FFT模式）

**目的**: 验证幅值测量功能

1. 确保示波器处于FFT模式
2. 点击"Cursor"按钮切换到"V-CUR"模式
3. 在波形区域上下拖动手指
4. 观察黄色水平线跟随移动
5. 观察标签实时显示幅值（如"-20.5dB"）
6. 拖动到最上方，观察幅值接近0dB
7. 拖动到最下方，观察幅值为最小值（如-60dB）

**预期结果**:
- ✅ 游标线流畅跟随触摸位置
- ✅ 幅值实时更新
- ✅ 显示1位小数精度
- ✅ 幅值范围正确（根据幅值范围设置）

### 测试6：边界保护

**目的**: 验证游标不会超出显示区域

1. 激活横轴游标
2. 尝试拖动到波形区域左侧外
3. 观察游标线停在左边界
4. 尝试拖动到波形区域右侧外
5. 观察游标线停在右边界
6. 切换到纵轴游标
7. 尝试拖动到波形区域上方外
8. 观察游标线停在上边界
9. 尝试拖动到波形区域下方外
10. 观察游标线停在下边界

**预期结果**:
- ✅ 游标线不会超出波形显示区域
- ✅ 标签始终可见
- ✅ 测量值在有效范围内

### 测试7：模式切换时的清理

**目的**: 验证切换模式时旧游标被正确清理

1. 激活横轴游标并移动到某个位置
2. 切换到纵轴游标
3. 观察横轴游标线完全消失
4. 观察纵轴游标线出现在中心位置
5. 切换到OFF模式
6. 观察所有游标线和标签都消失

**预期结果**:
- ✅ 旧游标对象被完全删除
- ✅ 新游标从中心位置开始
- ✅ 没有残留的游标线或标签

## 性能测试

### 测试8：拖动流畅度

**目的**: 验证游标拖动的响应性能

1. 激活游标（任意模式）
2. 快速左右或上下拖动
3. 观察游标线是否流畅跟随
4. 观察标签更新是否及时
5. 观察是否有卡顿或延迟

**预期结果**:
- ✅ 游标线实时跟随触摸
- ✅ 标签更新无明显延迟
- ✅ 无卡顿现象
- ✅ 帧率保持稳定

## 问题排查

### 问题1：游标线不显示

**可能原因**:
- LVGL对象创建失败
- 波形容器未正确初始化

**检查方法**:
```c
// 在events_init.c中添加日志
ESP_LOGI("Cursor", "Creating cursor line, mode=%d", osc_cursor_mode);
```

### 问题2：测量值不正确

**可能原因**:
- 坐标转换公式错误
- 刻度值未正确获取

**检查方法**:
```c
// 打印调试信息
ESP_LOGI("Cursor", "pos=%d, value=%.3f, scale=%.3f", 
         osc_cursor_position, calculated_value, scale_value);
```

### 问题3：拖动不流畅

**可能原因**:
- 事件处理频率过高
- 标签更新开销大

**优化方法**:
- 添加更新节流
- 减少不必要的重绘

## 测试通过标准

- ✅ 所有8个测试项目通过
- ✅ 无崩溃或异常
- ✅ 视觉效果符合专业示波器标准
- ✅ 测量精度满足要求
- ✅ 用户体验流畅

## 后续改进建议

1. **双游标测量**: 添加第二条游标线，显示Δ值
2. **游标跟踪**: 游标自动吸附到波形上
3. **数字输入**: 允许直接输入游标位置
4. **测量保存**: 保存测量结果到文件
5. **快捷键**: 添加硬件按钮快捷操作

## 相关文档

- [游标功能详细说明](OSCILLOSCOPE_CURSOR_MEASUREMENT.md)
- [示波器核心功能](OSCILLOSCOPE_DS100_REFACTOR.md)
- [性能优化指南](OSCILLOSCOPE_PERFORMANCE_OPTIMIZATION.md)
