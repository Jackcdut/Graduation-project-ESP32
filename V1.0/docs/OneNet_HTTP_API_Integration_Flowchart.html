<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneNetäº‘å¹³å°HTTP APIé›†æˆæŠ€æœ¯æµç¨‹å›¾</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'SimHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 30px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 30px;
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .section {
            background: #fff;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .section-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title .icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
        }
        
        /* æµç¨‹å›¾å®¹å™¨ */
        .flowchart {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
        }
        
        .flowchart-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            width: 100%;
        }
        
        /* æµç¨‹èŠ‚ç‚¹æ ·å¼ */
        .node {
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            font-size: 14px;
            min-width: 160px;
            position: relative;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .node:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .node-start, .node-end {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: #fff;
            border-radius: 25px;
            font-weight: bold;
        }
        
        .node-process {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
        }
        
        .node-decision {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: #fff;
            transform: rotate(0deg);
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            padding: 30px 40px;
            min-width: 180px;
        }
        
        .node-io {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: #fff;
            transform: skewX(-10deg);
        }
        
        .node-io span {
            display: block;
            transform: skewX(10deg);
        }
        
        .node-api {
            background: linear-gradient(135deg, #fa709a, #fee140);
            color: #333;
            border: 2px dashed #e91e63;
        }
        
        .node-data {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            color: #333;
            border-radius: 0 20px 0 20px;
        }
        
        .node-storage {
            background: linear-gradient(135deg, #d299c2, #fef9d7);
            color: #333;
            border-radius: 10px 10px 50% 50%;
            padding-bottom: 25px;
        }
        
        /* ç®­å¤´æ ·å¼ */
        .arrow {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #666;
            font-size: 12px;
            padding: 5px 0;
        }
        
        .arrow-down::before {
            content: '';
            width: 2px;
            height: 30px;
            background: linear-gradient(to bottom, #667eea, #764ba2);
        }
        
        .arrow-down::after {
            content: '';
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 12px solid #764ba2;
        }
        
        .arrow-right {
            flex-direction: row;
            padding: 0 10px;
        }
        
        .arrow-right::before {
            content: '';
            width: 40px;
            height: 2px;
            background: linear-gradient(to right, #667eea, #764ba2);
        }
        
        .arrow-right::after {
            content: '';
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 12px solid #764ba2;
        }
        
        .arrow-label {
            font-size: 11px;
            color: #888;
            margin: 5px 0;
            font-style: italic;
        }
        
        /* åˆ†æ”¯å®¹å™¨ */
        .branch-container {
            display: flex;
            gap: 60px;
            justify-content: center;
            position: relative;
        }
        
        .branch {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .branch-label {
            font-size: 12px;
            color: #4caf50;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .branch-label.no {
            color: #f44336;
        }
        
        /* å¹¶è¡Œå¤„ç† */
        .parallel-container {
            display: flex;
            gap: 30px;
            justify-content: center;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px dashed #dee2e6;
        }
        
        .parallel-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        /* ä»£ç å— */
        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px 20px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 15px 0;
            line-height: 1.6;
        }
        
        .code-block .keyword {
            color: #569cd6;
        }
        
        .code-block .string {
            color: #ce9178;
        }
        
        .code-block .comment {
            color: #6a9955;
        }
        
        .code-block .function {
            color: #dcdcaa;
        }
        
        /* æ—¶åºå›¾æ ·å¼ */
        .sequence-diagram {
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 20px;
            background: #fafafa;
            border-radius: 12px;
        }
        
        .sequence-row {
            display: grid;
            grid-template-columns: 120px 1fr 120px 1fr 120px;
            align-items: center;
            min-height: 60px;
        }
        
        .sequence-entity {
            text-align: center;
            padding: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border-radius: 8px;
            font-weight: bold;
            font-size: 13px;
        }
        
        .sequence-lifeline {
            width: 2px;
            background: #ccc;
            height: 100%;
            margin: 0 auto;
        }
        
        .sequence-message {
            position: relative;
            padding: 8px 15px;
            font-size: 12px;
            color: #333;
        }
        
        .sequence-message.right::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }
        
        .sequence-message.right::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 10px solid #667eea;
        }
        
        .sequence-message.left::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: #4caf50;
        }
        
        .sequence-message.left::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-right: 10px solid #4caf50;
        }
        
        .sequence-message span {
            position: relative;
            z-index: 1;
            background: #fafafa;
            padding: 2px 8px;
        }
        
        /* æ¶æ„å›¾ */
        .architecture {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .arch-layer {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .arch-box {
            padding: 20px 30px;
            border-radius: 12px;
            text-align: center;
            min-width: 200px;
            transition: transform 0.3s;
        }
        
        .arch-box:hover {
            transform: scale(1.05);
        }
        
        .arch-box h4 {
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .arch-box p {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .arch-cloud {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
        }
        
        .arch-network {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: #fff;
        }
        
        .arch-device {
            background: linear-gradient(135deg, #fa709a, #fee140);
            color: #333;
        }
        
        .arch-module {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: #fff;
        }
        
        .arch-connector {
            display: flex;
            justify-content: center;
            padding: 10px 0;
        }
        
        .arch-connector span {
            font-size: 24px;
            color: #667eea;
        }
        
        /* è¡¨æ ¼æ ·å¼ */
        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .info-table th, .info-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        
        .info-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            font-weight: 600;
        }
        
        .info-table tr:hover {
            background: #f8f9fa;
        }
        
        .info-table code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        
        /* çŠ¶æ€æœº */
        .state-machine {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            padding: 20px;
        }
        
        .state {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 13px;
            text-align: center;
            position: relative;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .state-idle {
            background: linear-gradient(135deg, #bdc3c7, #2c3e50);
        }
        
        .state-activating {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }
        
        .state-activated {
            background: linear-gradient(135deg, #11998e, #38ef7d);
        }
        
        .state-error {
            background: linear-gradient(135deg, #eb3349, #f45c43);
        }
        
        .state-transition {
            position: absolute;
            font-size: 10px;
            color: #666;
            white-space: nowrap;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .flowchart-row {
                flex-direction: column;
            }
            
            .branch-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .parallel-container {
                flex-direction: column;
            }
            
            .sequence-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        /* æ‰“å°æ ·å¼ */
        @media print {
            body {
                background: #fff;
                padding: 10px;
            }
            
            .section {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¡ OneNetäº‘å¹³å°HTTP APIé›†æˆæŠ€æœ¯æµç¨‹å›¾</h1>
        
        <!-- ç³»ç»Ÿæ¶æ„å›¾ -->
        <div class="section">
            <div class="section-title">
                <div class="icon">1</div>
                ç³»ç»Ÿæ•´ä½“æ¶æ„
            </div>
            <div class="architecture">
                <div class="arch-layer">
                    <div class="arch-box arch-cloud">
                        <h4>â˜ï¸ OneNetäº‘å¹³å°</h4>
                        <p>open.iot.10086.cn</p>
                        <p>iot-api.heclouds.com</p>
                    </div>
                </div>
                <div class="arch-connector"><span>â¬‡ï¸ HTTPS (443) â¬†ï¸</span></div>
                <div class="arch-layer">
                    <div class="arch-box arch-network">
                        <h4>ğŸŒ ç½‘ç»œå±‚</h4>
                        <p>Wi-Fi (ESP32-C6)</p>
                        <p>SDIOé€šä¿¡</p>
                    </div>
                </div>
                <div class="arch-connector"><span>â¬‡ï¸ ESP-Hosted â¬†ï¸</span></div>
                <div class="arch-layer">
                    <div class="arch-box arch-module">
                        <h4>ğŸ“¦ cloud_manager</h4>
                        <p>è®¾å¤‡æ¿€æ´»ç®¡ç†</p>
                        <p>ä¸Šä¼ é˜Ÿåˆ—è°ƒåº¦</p>
                    </div>
                    <div class="arch-box arch-module">
                        <h4>ğŸ” activation_server</h4>
                        <p>APçƒ­ç‚¹é…ç½‘</p>
                        <p>HTTPæ¿€æ´»æœåŠ¡</p>
                    </div>
                    <div class="arch-box arch-module">
                        <h4>ğŸ“¤ wifi_onenet</h4>
                        <p>HTTP APIå°è£…</p>
                        <p>Tokenè®¤è¯</p>
                    </div>
                </div>
                <div class="arch-connector"><span>â¬‡ï¸ APIè°ƒç”¨ â¬†ï¸</span></div>
                <div class="arch-layer">
                    <div class="arch-box arch-device">
                        <h4>ğŸ”§ ESP32-P4ä¸»æ§</h4>
                        <p>ä¸šåŠ¡é€»è¾‘å¤„ç†</p>
                        <p>æ•°æ®é‡‡é›†ä¸å­˜å‚¨</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®¾å¤‡æ¿€æ´»æµç¨‹å›¾ -->
        <div class="section">
            <div class="section-title">
                <div class="icon">2</div>
                è®¾å¤‡è‡ªåŠ¨æ³¨å†Œä¸æ¿€æ´»æµç¨‹
            </div>
            <div class="flowchart">
                <div class="node node-start">å¼€å§‹ï¼šè®¾å¤‡ä¸Šç”µ</div>
                <div class="arrow arrow-down"></div>
                
                <div class="node node-process">åˆå§‹åŒ–äº‘ç®¡ç†æ¨¡å—<br><small>cloud_manager_init()</small></div>
                <div class="arrow arrow-down"></div>
                
                <div class="node node-io"><span>ä»NVSè¯»å–æ¿€æ´»çŠ¶æ€</span></div>
                <div class="arrow arrow-down"></div>
                
                <div class="node node-decision">è®¾å¤‡å·²æ¿€æ´»?</div>
                
                <div class="branch-container" style="margin-top: 20px;">
                    <div class="branch">
                        <div class="branch-label">æ˜¯ âœ“</div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-io"><span>åŠ è½½è®¾å¤‡å‡­è¯<br>did, pid, sec_key</span></div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-process">åˆå§‹åŒ–HTTPå®¢æˆ·ç«¯<br><small>onenet_http_init()</small></div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-api">è°ƒç”¨è®¾å¤‡ä¸Šçº¿API<br><small>POST /device/online</small></div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-end">è¿›å…¥æ­£å¸¸å·¥ä½œæ¨¡å¼</div>
                    </div>
                    
                    <div class="branch">
                        <div class="branch-label no">å¦ âœ—</div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-process">å¯åŠ¨APçƒ­ç‚¹æ¨¡å¼<br><small>SSID: ExDebugTool_Config</small></div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-process">å¯åŠ¨HTTPé…ç½®æœåŠ¡å™¨<br><small>192.168.4.1:80</small></div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-io"><span>ç­‰å¾…ç”¨æˆ·è®¿é—®<br>æ¿€æ´»é¡µé¢</span></div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-process">ç”¨æˆ·ç‚¹å‡»"æ¿€æ´»è®¾å¤‡"</div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-api">è°ƒç”¨è®¾å¤‡åˆ›å»ºAPI<br><small>POST /device/create</small></div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-decision">æ³¨å†ŒæˆåŠŸ?</div>
                        <div style="display: flex; gap: 40px; margin-top: 15px;">
                            <div style="text-align: center;">
                                <div class="branch-label">æ˜¯ âœ“</div>
                                <div class="arrow arrow-down"></div>
                                <div class="node node-storage">ä¿å­˜å‡­è¯åˆ°NVS</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="branch-label no">å¦ âœ—</div>
                                <div class="arrow arrow-down"></div>
                                <div class="node node-process" style="background: linear-gradient(135deg, #eb3349, #f45c43);">æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯<br>ç­‰å¾…é‡è¯•</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="code-block">
<span class="comment">// è®¾å¤‡è‡ªåŠ¨æ³¨å†Œæ ¸å¿ƒä»£ç  (cloud_activation_server.c)</span>
<span class="keyword">static</span> esp_err_t <span class="function">register_device_onenet</span>(<span class="keyword">const char</span> *device_name, ...) {
    <span class="comment">// 1. æ„å»ºè¯·æ±‚ä½“</span>
    cJSON *body = <span class="function">cJSON_CreateObject</span>();
    <span class="function">cJSON_AddStringToObject</span>(body, <span class="string">"product_id"</span>, ONENET_HTTP_PRODUCT_ID);
    <span class="function">cJSON_AddStringToObject</span>(body, <span class="string">"device_name"</span>, device_name);
    
    <span class="comment">// 2. ç”Ÿæˆäº§å“çº§Token (HMAC-MD5)</span>
    <span class="function">cloud_activation_generate_token</span>(product_id, access_key, auth_token, <span class="keyword">sizeof</span>(auth_token));
    
    <span class="comment">// 3. å‘é€HTTPSè¯·æ±‚åˆ° iot-api.heclouds.com/device/create</span>
    <span class="function">esp_http_client_set_header</span>(client, <span class="string">"authorization"</span>, auth_token);
    <span class="function">esp_http_client_perform</span>(client);
    
    <span class="comment">// 4. è§£æå“åº”ï¼Œè·å– did, pid, sec_key</span>
    cJSON *data = <span class="function">cJSON_GetObjectItem</span>(resp_json, <span class="string">"data"</span>);
    <span class="comment">// did: è®¾å¤‡å”¯ä¸€ID, sec_key: è®¾å¤‡å¯†é’¥(ç”¨äºåç»­è®¤è¯)</span>
}
            </div>
        </div>
        
        <!-- Tokenè®¤è¯æµç¨‹ -->
        <div class="section">
            <div class="section-title">
                <div class="icon">3</div>
                åŒå±‚Tokenè®¤è¯æœºåˆ¶
            </div>
            
            <table class="info-table">
                <tr>
                    <th>è®¤è¯å±‚çº§</th>
                    <th>ä½¿ç”¨åœºæ™¯</th>
                    <th>ç­¾åç®—æ³•</th>
                    <th>å¯†é’¥æ¥æº</th>
                    <th>æœ‰æ•ˆæœŸ</th>
                </tr>
                <tr>
                    <td><strong>äº§å“çº§Token</strong></td>
                    <td>è®¾å¤‡æ³¨å†Œã€æ‰¹é‡ç®¡ç†</td>
                    <td><code>HMAC-MD5</code></td>
                    <td>äº§å“Access Key</td>
                    <td>1å¹´</td>
                </tr>
                <tr>
                    <td><strong>è®¾å¤‡çº§Token</strong></td>
                    <td>æ•°æ®ä¸ŠæŠ¥ã€çŠ¶æ€æ›´æ–°</td>
                    <td><code>HMAC-SHA256</code></td>
                    <td>è®¾å¤‡sec_key</td>
                    <td>1å¹´</td>
                </tr>
            </table>
            
            <div class="flowchart" style="margin-top: 20px;">
                <div style="display: flex; gap: 60px; flex-wrap: wrap; justify-content: center;">
                    <!-- äº§å“çº§Token -->
                    <div style="flex: 1; min-width: 300px;">
                        <h4 style="text-align: center; color: #667eea; margin-bottom: 15px;">äº§å“çº§Tokenç”Ÿæˆæµç¨‹</h4>
                        <div class="flowchart">
                            <div class="node node-io"><span>è¾“å…¥: product_id, access_key</span></div>
                            <div class="arrow arrow-down"></div>
                            <div class="node node-process">æ„å»ºç­¾åå­—ç¬¦ä¸²<br><small>{expire}\nmd5\nproducts/{pid}\n2018-10-31</small></div>
                            <div class="arrow arrow-down"></div>
                            <div class="node node-process">Base64è§£ç  access_key</div>
                            <div class="arrow arrow-down"></div>
                            <div class="node node-process" style="background: linear-gradient(135deg, #f093fb, #f5576c);">HMAC-MD5 ç­¾å</div>
                            <div class="arrow arrow-down"></div>
                            <div class="node node-process">Base64ç¼–ç ç­¾åç»“æœ</div>
                            <div class="arrow arrow-down"></div>
                            <div class="node node-process">URLç¼–ç ç‰¹æ®Šå­—ç¬¦<br><small>+ â†’ %2B, / â†’ %2F, = â†’ %3D</small></div>
                            <div class="arrow arrow-down"></div>
                            <div class="node node-data">è¾“å‡º: äº§å“çº§Token</div>
                        </div>
                    </div>
                    
                    <!-- è®¾å¤‡çº§Token -->
                    <div style="flex: 1; min-width: 300px;">
                        <h4 style="text-align: center; color: #764ba2; margin-bottom: 15px;">è®¾å¤‡çº§Tokenç”Ÿæˆæµç¨‹</h4>
                        <div class="flowchart">
                            <div class="node node-io"><span>è¾“å…¥: product_id, device_name, sec_key</span></div>
                            <div class="arrow arrow-down"></div>
                            <div class="node node-process">æ„å»ºç­¾åå­—ç¬¦ä¸²<br><small>{expire}\nsha256\nproducts/{pid}/devices/{name}\n2018-10-31</small></div>
                            <div class="arrow arrow-down"></div>
                            <div class="node node-process">Base64è§£ç  sec_key</div>
                            <div class="arrow arrow-down"></div>
                            <div class="node node-process" style="background: linear-gradient(135deg, #11998e, #38ef7d);">HMAC-SHA256 ç­¾å</div>
                            <div class="arrow arrow-down"></div>
                            <div class="node node-process">Base64ç¼–ç ç­¾åç»“æœ</div>
                            <div class="arrow arrow-down"></div>
                            <div class="node node-process">URLç¼–ç ç‰¹æ®Šå­—ç¬¦<br><small>+ â†’ %2B, / â†’ %2F, = â†’ %3D</small></div>
                            <div class="arrow arrow-down"></div>
                            <div class="node node-data">è¾“å‡º: è®¾å¤‡çº§Token</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="code-block">
<span class="comment">// Tokenæ ¼å¼</span>
version=2018-10-31&res=products%2F{pid}%2Fdevices%2F{device_name}&et={expire_timestamp}&method=sha256&sign={url_encoded_signature}

<span class="comment">// è®¾å¤‡çº§Tokenç”Ÿæˆæ ¸å¿ƒä»£ç  (wifi_onenet.c)</span>
<span class="keyword">static</span> esp_err_t <span class="function">generate_device_token</span>(...) {
    <span class="comment">// ç­¾åå­—ç¬¦ä¸²: {expire}\n{method}\n{resource}\n{version}</span>
    <span class="function">snprintf</span>(string_to_sign, <span class="keyword">sizeof</span>(string_to_sign),
             <span class="string">"%lld\nsha256\nproducts/%s/devices/%s\n2018-10-31"</span>,
             expire_time, product_id, device_name);
    
    <span class="comment">// Base64è§£ç å¯†é’¥</span>
    <span class="function">mbedtls_base64_decode</span>(key_decoded, ..., sec_key, <span class="function">strlen</span>(sec_key));
    
    <span class="comment">// HMAC-SHA256ç­¾å</span>
    <span class="function">mbedtls_md_hmac_starts</span>(&ctx, key_decoded, key_decoded_len);
    <span class="function">mbedtls_md_hmac_update</span>(&ctx, string_to_sign, <span class="function">strlen</span>(string_to_sign));
    <span class="function">mbedtls_md_hmac_finish</span>(&ctx, hmac);
}
            </div>
        </div>

        <!-- æ•°æ®ä¸ŠæŠ¥æµç¨‹ -->
        <div class="section">
            <div class="section-title">
                <div class="icon">4</div>             HTTPæ•°æ®ä¸ŠæŠ¥æµç¨‹
            </div>
            
            <div class="flowchart">
                <div class="node node-start">æ•°æ®ä¸ŠæŠ¥è¯·æ±‚</div>
                <div class="arrow arrow-down"></div>
                
                <div class="node node-decision">WiFiå·²è¿æ¥?</div>
                <div style="display: flex; gap: 80px; margin-top: 15px; justify-content: center;">
                    <div style="text-align: center;">
                        <div class="branch-label no">å¦</div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-process" style="background: linear-gradient(135deg, #eb3349, #f45c43);">è¿”å›é”™è¯¯<br>ESP_ERR_WIFI_NOT_CONNECT</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="branch-label">æ˜¯</div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-decision">è®¾å¤‡å·²æ¿€æ´»?</div>
                    </div>
                </div>
                
                <div class="arrow arrow-down" style="margin-top: 20px;"></div>
                
                <div class="node node-io"><span>è·å–è®¾å¤‡å‡­è¯<br>cloud_manager_get_device_credentials()</span></div>
                <div class="arrow arrow-down"></div>
                
                <div class="node node-process">ç”Ÿæˆè®¾å¤‡çº§Token<br><small>generate_device_token()</small></div>
                <div class="arrow arrow-down"></div>
                
                <div class="node node-data">æ„é€ OneJSONè¯·æ±‚ä½“</div>
                <div class="arrow arrow-down"></div>
                
                <div class="node node-process">URLç¼–ç Topicå‚æ•°<br><small>$sys/{pid}/{name}/thing/property/post</small></div>
                <div class="arrow arrow-down"></div>
                
                <div class="node node-api">å‘é€HTTPS POSTè¯·æ±‚<br><small>open.iot.10086.cn:443</small></div>
                <div class="arrow arrow-down"></div>
                
                <div class="node node-decision">å“åº”ç  = "succ"?</div>
                <div style="display: flex; gap: 60px; margin-top: 15px; justify-content: center;">
                    <div style="text-align: center;">
                        <div class="branch-label">æ˜¯</div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-end">ä¸ŠæŠ¥æˆåŠŸ</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="branch-label no">å¦</div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-process" style="background: linear-gradient(135deg, #f093fb, #f5576c);">è§£æé”™è¯¯ç <br>è®°å½•æ—¥å¿—</div>
                    </div>
                </div>
            </div>
            
            <h4 style="margin: 25px 0 15px; color: #333;">OneJSONæ•°æ®æ ¼å¼è§„èŒƒ</h4>
            <div class="code-block">
<span class="comment">// å±æ€§ä¸ŠæŠ¥è¯·æ±‚æ ¼å¼</span>
{
    <span class="string">"id"</span>: <span class="string">"æ¶ˆæ¯å”¯ä¸€ID"</span>,
    <span class="string">"version"</span>: <span class="string">"1.0"</span>,
    <span class="string">"params"</span>: {
        <span class="string">"å±æ€§æ ‡è¯†ç¬¦"</span>: {
            <span class="string">"value"</span>: å±æ€§å€¼,
            <span class="string">"time"</span>: æ—¶é—´æˆ³(å¯é€‰)
        }
    }
}

<span class="comment">// ç¤ºä¾‹: ä¸ŠæŠ¥ç¤ºæ³¢å™¨æ•°æ®</span>
{
    <span class="string">"id"</span>: <span class="string">"1702900000000"</span>,
    <span class="string">"version"</span>: <span class="string">"1.0"</span>,
    <span class="string">"params"</span>: {
        <span class="string">"Oscilloscope_data"</span>: {
            <span class="string">"value"</span>: 3.14
        }
    }
}

<span class="comment">// WiFiå®šä½æ•°æ®ä¸ŠæŠ¥ (ç³»ç»ŸåŠŸèƒ½ç‚¹)</span>
{
    <span class="string">"id"</span>: <span class="string">"123"</span>,
    <span class="string">"version"</span>: <span class="string">"1.0"</span>,
    <span class="string">"params"</span>: {
        <span class="string">"$OneNET_LBS_WIFI"</span>: {
            <span class="string">"value"</span>: {
                <span class="string">"macs"</span>: <span class="string">"AA:BB:CC:DD:EE:FF,-65|11:22:33:44:55:66,-70"</span>,
                <span class="string">"mmac"</span>: <span class="string">"AA:BB:CC:DD:EE:FF,-65,MyWiFi"</span>,
                <span class="string">"smac"</span>: <span class="string">"è®¾å¤‡MACåœ°å€"</span>
            }
        }
    }
}
            </div>
        </div>
        
        <!-- æ—¶åºå›¾ -->
        <div class="section">
            <div class="section-title">
                <div class="icon">5</div>
                è®¾å¤‡æ¿€æ´»æ—¶åºå›¾
            </div>
            
            <div style="overflow-x: auto;">
                <svg viewBox="0 0 900 650" style="width: 100%; max-width: 900px; margin: 0 auto; display: block;">
                    <!-- å®ä½“ -->
                    <rect x="50" y="20" width="100" height="40" rx="8" fill="url(#grad1)"/>
                    <text x="100" y="45" text-anchor="middle" fill="white" font-size="12" font-weight="bold">ç”¨æˆ·æ‰‹æœº</text>
                    
                    <rect x="250" y="20" width="100" height="40" rx="8" fill="url(#grad2)"/>
                    <text x="300" y="45" text-anchor="middle" fill="white" font-size="12" font-weight="bold">ESP32è®¾å¤‡</text>
                    
                    <rect x="450" y="20" width="120" height="40" rx="8" fill="url(#grad3)"/>
                    <text x="510" y="45" text-anchor="middle" fill="white" font-size="12" font-weight="bold">HTTPæœåŠ¡å™¨</text>
                    
                    <rect x="680" y="20" width="120" height="40" rx="8" fill="url(#grad4)"/>
                    <text x="740" y="45" text-anchor="middle" fill="white" font-size="12" font-weight="bold">OneNetäº‘å¹³å°</text>
                    
                    <!-- ç”Ÿå‘½çº¿ -->
                    <line x1="100" y1="60" x2="100" y2="620" stroke="#ccc" stroke-width="2" stroke-dasharray="5,5"/>
                    <line x1="300" y1="60" x2="300" y2="620" stroke="#ccc" stroke-width="2" stroke-dasharray="5,5"/>
                    <line x1="510" y1="60" x2="510" y2="620" stroke="#ccc" stroke-width="2" stroke-dasharray="5,5"/>
                    <line x1="740" y1="60" x2="740" y2="620" stroke="#ccc" stroke-width="2" stroke-dasharray="5,5"/>
                    
                    <!-- æ¶ˆæ¯1: è¿æ¥AP -->
                    <line x1="100" y1="100" x2="300" y2="100" stroke="#667eea" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <text x="200" y="90" text-anchor="middle" font-size="11" fill="#333">1. è¿æ¥WiFiçƒ­ç‚¹</text>
                    <text x="200" y="115" text-anchor="middle" font-size="10" fill="#888">SSID: ExDebugTool_Config</text>
                    
                    <!-- æ¶ˆæ¯2: è®¿é—®é¡µé¢ -->
                    <line x1="100" y1="160" x2="510" y2="160" stroke="#667eea" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <text x="305" y="150" text-anchor="middle" font-size="11" fill="#333">2. GET http://192.168.4.1/</text>
                    
                    <!-- æ¶ˆæ¯3: è¿”å›HTML -->
                    <line x1="510" y1="200" x2="100" y2="200" stroke="#4caf50" stroke-width="2" marker-end="url(#arrowhead-green)"/>
                    <text x="305" y="190" text-anchor="middle" font-size="11" fill="#333">3. è¿”å›æ¿€æ´»é¡µé¢HTML</text>
                    
                    <!-- æ¶ˆæ¯4: ç‚¹å‡»æ¿€æ´» -->
                    <line x1="100" y1="260" x2="510" y2="260" stroke="#667eea" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <text x="305" y="250" text-anchor="middle" font-size="11" fill="#333">4. POST /activate</text>
                    <text x="305" y="275" text-anchor="middle" font-size="10" fill="#888">ç”¨æˆ·ç‚¹å‡»"æ¿€æ´»è®¾å¤‡"æŒ‰é’®</text>
                    
                    <!-- æ¿€æ´»æ¡† -->
                    <rect x="280" y="300" width="40" height="180" fill="#e3f2fd" stroke="#667eea" stroke-width="1"/>
                    <rect x="490" y="300" width="40" height="180" fill="#e3f2fd" stroke="#667eea" stroke-width="1"/>
                    
                    <!-- æ¶ˆæ¯5: è°ƒç”¨OneNet API -->
                    <line x1="510" y1="330" x2="740" y2="330" stroke="#f44336" stroke-width="2" marker-end="url(#arrowhead-red)"/>
                    <text x="625" y="320" text-anchor="middle" font-size="11" fill="#333">5. POST /device/create</text>
                    <text x="625" y="345" text-anchor="middle" font-size="10" fill="#888">æºå¸¦äº§å“çº§Token</text>
                    
                    <!-- æ¶ˆæ¯6: è¿”å›è®¾å¤‡å‡­è¯ -->
                    <line x1="740" y1="390" x2="510" y2="390" stroke="#4caf50" stroke-width="2" marker-end="url(#arrowhead-green)"/>
                    <text x="625" y="380" text-anchor="middle" font-size="11" fill="#333">6. è¿”å› {did, pid, sec_key}</text>
                    
                    <!-- æ¶ˆæ¯7: ä¿å­˜NVS -->
                    <rect x="285" y="420" width="30" height="30" fill="#fff3e0" stroke="#ff9800" stroke-width="1"/>
                    <text x="300" y="465" text-anchor="middle" font-size="10" fill="#333">7. ä¿å­˜åˆ°NVS</text>
                    
                    <!-- æ¶ˆæ¯8: è¿”å›æˆåŠŸ -->
                    <line x1="510" y1="510" x2="100" y2="510" stroke="#4caf50" stroke-width="2" marker-end="url(#arrowhead-green)"/>
                    <text x="305" y="500" text-anchor="middle" font-size="11" fill="#333">8. è¿”å›æ¿€æ´»æˆåŠŸJSON</text>
                    <text x="305" y="525" text-anchor="middle" font-size="10" fill="#888">{success: true, device_id: "xxx"}</text>
                    
                    <!-- æ¶ˆæ¯9: æ˜¾ç¤ºç»“æœ -->
                    <rect x="80" y="560" width="40" height="30" fill="#e8f5e9" stroke="#4caf50" stroke-width="1"/>
                    <text x="100" y="610" text-anchor="middle" font-size="10" fill="#333">9. æ˜¾ç¤ºæ¿€æ´»æˆåŠŸ</text>
                    
                    <!-- æ¸å˜å®šä¹‰ -->
                    <defs>
                        <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#667eea"/>
                            <stop offset="100%" style="stop-color:#764ba2"/>
                        </linearGradient>
                        <linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#11998e"/>
                            <stop offset="100%" style="stop-color:#38ef7d"/>
                        </linearGradient>
                        <linearGradient id="grad3" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#fa709a"/>
                            <stop offset="100%" style="stop-color:#fee140"/>
                        </linearGradient>
                        <linearGradient id="grad4" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#4facfe"/>
                            <stop offset="100%" style="stop-color:#00f2fe"/>
                        </linearGradient>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#667eea"/>
                        </marker>
                        <marker id="arrowhead-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#4caf50"/>
                        </marker>
                        <marker id="arrowhead-red" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#f44336"/>
                        </marker>
                    </defs>
                </svg>
            </div>
        </div>
        
        <!-- è®¾å¤‡çŠ¶æ€æœº -->
        <div class="section">
            <div class="section-title">
                <div class="icon">6</div>
                è®¾å¤‡æ¿€æ´»çŠ¶æ€æœº
            </div>
            
            <div style="overflow-x: auto;">
                <svg viewBox="0 0 800 300" style="width: 100%; max-width: 800px; margin: 0 auto; display: block;">
                    <!-- çŠ¶æ€èŠ‚ç‚¹ -->
                    <circle cx="100" cy="150" r="60" fill="url(#state-idle)"/>
                    <text x="100" y="145" text-anchor="middle" fill="white" font-size="11" font-weight="bold">NOT_ACTIVATED</text>
                    <text x="100" y="162" text-anchor="middle" fill="white" font-size="10">æœªæ¿€æ´»</text>
                    
                    <circle cx="300" cy="150" r="60" fill="url(#state-activating)"/>
                    <text x="300" y="145" text-anchor="middle" fill="white" font-size="11" font-weight="bold">ACTIVATING</text>
                    <text x="300" y="162" text-anchor="middle" fill="white" font-size="10">æ¿€æ´»ä¸­</text>
                    
                    <circle cx="500" cy="150" r="60" fill="url(#state-activated)"/>
                    <text x="500" y="145" text-anchor="middle" fill="white" font-size="11" font-weight="bold">ACTIVATED</text>
                    <text x="500" y="162" text-anchor="middle" fill="white" font-size="10">å·²æ¿€æ´»</text>
                    
                    <circle cx="700" cy="150" r="60" fill="url(#state-error)"/>
                    <text x="700" y="145" text-anchor="middle" fill="white" font-size="11" font-weight="bold">ERROR</text>
                    <text x="700" y="162" text-anchor="middle" fill="white" font-size="10">é”™è¯¯</text>
                    
                    <!-- è½¬æ¢ç®­å¤´ -->
                    <path d="M 160 150 L 230 150" stroke="#333" stroke-width="2" fill="none" marker-end="url(#arrow-black)"/>
                    <text x="195" y="140" text-anchor="middle" font-size="9" fill="#666">start_activation()</text>
                    
                    <path d="M 360 150 L 430 150" stroke="#4caf50" stroke-width="2" fill="none" marker-end="url(#arrow-green2)"/>
                    <text x="395" y="140" text-anchor="middle" font-size="9" fill="#4caf50">æ³¨å†ŒæˆåŠŸ</text>
                    
                    <path d="M 340 100 Q 500 30 660 100" stroke="#f44336" stroke-width="2" fill="none" marker-end="url(#arrow-red2)"/>
                    <text x="500" y="50" text-anchor="middle" font-size="9" fill="#f44336">æ³¨å†Œå¤±è´¥</text>
                    
                    <path d="M 660 200 Q 400 280 140 200" stroke="#ff9800" stroke-width="2" fill="none" marker-end="url(#arrow-orange)"/>
                    <text x="400" y="270" text-anchor="middle" font-size="9" fill="#ff9800">clear_activation() / é‡è¯•</text>
                    
                    <!-- è‡ªå¾ªç¯: å·²æ¿€æ´»çŠ¶æ€ -->
                    <path d="M 540 110 Q 580 60 540 110" stroke="#4caf50" stroke-width="1.5" fill="none"/>
                    <text x="570" y="75" text-anchor="middle" font-size="8" fill="#4caf50">æ•°æ®ä¸ŠæŠ¥</text>
                    
                    <defs>
                        <linearGradient id="state-idle" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#bdc3c7"/>
                            <stop offset="100%" style="stop-color:#2c3e50"/>
                        </linearGradient>
                        <linearGradient id="state-activating" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#f093fb"/>
                            <stop offset="100%" style="stop-color:#f5576c"/>
                        </linearGradient>
                        <linearGradient id="state-activated" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#11998e"/>
                            <stop offset="100%" style="stop-color:#38ef7d"/>
                        </linearGradient>
                        <linearGradient id="state-error" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#eb3349"/>
                            <stop offset="100%" style="stop-color:#f45c43"/>
                        </linearGradient>
                        <marker id="arrow-black" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
                        </marker>
                        <marker id="arrow-green2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#4caf50"/>
                        </marker>
                        <marker id="arrow-red2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#f44336"/>
                        </marker>
                        <marker id="arrow-orange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#ff9800"/>
                        </marker>
                    </defs>
                </svg>
            </div>
            
            <table class="info-table" style="margin-top: 20px;">
                <tr>
                    <th>çŠ¶æ€</th>
                    <th>æšä¸¾å€¼</th>
                    <th>æè¿°</th>
                    <th>è§¦å‘æ¡ä»¶</th>
                </tr>
                <tr>
                    <td><span style="color: #2c3e50;">â—</span> NOT_ACTIVATED</td>
                    <td><code>0</code></td>
                    <td>è®¾å¤‡æœªæ¿€æ´»ï¼Œéœ€è¦è¿›è¡Œäº‘ç«¯æ³¨å†Œ</td>
                    <td>åˆå§‹çŠ¶æ€ / æ¸…é™¤æ¿€æ´»</td>
                </tr>
                <tr>
                    <td><span style="color: #f5576c;">â—</span> ACTIVATING</td>
                    <td><code>1</code></td>
                    <td>æ­£åœ¨è¿›è¡Œè®¾å¤‡æ³¨å†Œ</td>
                    <td>è°ƒç”¨ start_activation()</td>
                </tr>
                <tr>
                    <td><span style="color: #38ef7d;">â—</span> ACTIVATED</td>
                    <td><code>2</code></td>
                    <td>è®¾å¤‡å·²æ¿€æ´»ï¼Œå¯æ­£å¸¸ä¸ŠæŠ¥æ•°æ®</td>
                    <td>OneNetæ³¨å†ŒæˆåŠŸ</td>
                </tr>
                <tr>
                    <td><span style="color: #f45c43;">â—</span> ERROR</td>
                    <td><code>3</code></td>
                    <td>æ¿€æ´»è¿‡ç¨‹å‡ºé”™</td>
                    <td>ç½‘ç»œé”™è¯¯ / APIè¿”å›å¤±è´¥</td>
                </tr>
            </table>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ æµç¨‹ -->
        <div class="section">
            <div class="section-title">
                <div class="icon">7</div>
                æ–‡ä»¶ä¸Šä¼ é˜Ÿåˆ—ç®¡ç†æµç¨‹
            </div>
            
            <div class="flowchart">
                <div class="node node-start">åˆ›å»ºä¸Šä¼ ä»»åŠ¡</div>
                <div class="arrow arrow-down"></div>
                
                <div class="node node-io"><span>æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨<br>stat(file_path)</span></div>
                <div class="arrow arrow-down"></div>
                
                <div class="node node-decision">æ–‡ä»¶å·²ä¸Šä¼ ?<br><small>hashæ£€æŸ¥</small></div>
                <div style="display: flex; gap: 60px; margin-top: 15px; justify-content: center;">
                    <div style="text-align: center;">
                        <div class="branch-label no">å¦ (æ–°æ–‡ä»¶)</div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-process">åŠ å…¥ä¸Šä¼ é˜Ÿåˆ—<br><small>status = PENDING</small></div>
                    </div>
                    <div style="text-align: center;">
                        <div class="branch-label">æ˜¯ (å·²å­˜åœ¨)</div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-data">è¿”å›å·²ä¸Šä¼ çŠ¶æ€<br><small>è·³è¿‡é‡å¤ä¸Šä¼ </small></div>
                    </div>
                </div>
                
                <div class="arrow arrow-down" style="margin-top: 20px;"></div>
                
                <div class="node node-process">cloud_manager_process()<br><small>ä¸»å¾ªç¯è°ƒåº¦</small></div>
                <div class="arrow arrow-down"></div>
                
                <div class="node node-decision">æœ‰å¾…å¤„ç†ä»»åŠ¡?</div>
                <div class="arrow arrow-down"></div>
                <div class="arrow-label">æ˜¯</div>
                
                <div class="node node-process">è®¾ç½®çŠ¶æ€ UPLOADING<br>è°ƒç”¨ä¸Šä¼ å‡½æ•°</div>
                <div class="arrow arrow-down"></div>
                
                <div class="node node-api">HTTP POST æ–‡ä»¶æ•°æ®<br><small>upload_file_data_to_onenet()</small></div>
                <div class="arrow arrow-down"></div>
                
                <div class="node node-decision">ä¸Šä¼ æˆåŠŸ?</div>
                <div style="display: flex; gap: 80px; margin-top: 15px; justify-content: center;">
                    <div style="text-align: center;">
                        <div class="branch-label">æ˜¯</div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-storage">æ ‡è®°æ–‡ä»¶å·²ä¸Šä¼ <br>æ›´æ–°ç»Ÿè®¡ä¿¡æ¯</div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-end">status = SUCCESS</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="branch-label no">å¦</div>
                        <div class="arrow arrow-down"></div>
                        <div class="node node-decision">é‡è¯•æ¬¡æ•° < 3?</div>
                        <div style="display: flex; gap: 30px; margin-top: 10px;">
                            <div style="text-align: center;">
                                <div class="branch-label">æ˜¯</div>
                                <div class="arrow arrow-down"></div>
                                <div class="node node-process" style="font-size: 12px;">retry_count++<br>é‡æ–°å…¥é˜Ÿ</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="branch-label no">å¦</div>
                                <div class="arrow arrow-down"></div>
                                <div class="node node-process" style="background: linear-gradient(135deg, #eb3349, #f45c43); font-size: 12px;">status = FAILED</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <h4 style="margin: 25px 0 15px; color: #333;">ä¸Šä¼ ä»»åŠ¡æ•°æ®ç»“æ„</h4>
            <div class="code-block">
<span class="keyword">typedef struct</span> {
    uint32_t task_id;               <span class="comment">// ä»»åŠ¡å”¯ä¸€æ ‡è¯†</span>
    <span class="keyword">char</span> file_path[64];             <span class="comment">// SDå¡æ–‡ä»¶è·¯å¾„</span>
    <span class="keyword">char</span> file_name[32];             <span class="comment">// æ–‡ä»¶å</span>
    uint32_t file_size;             <span class="comment">// æ–‡ä»¶å¤§å°(å­—èŠ‚)</span>
    upload_file_type_t file_type;   <span class="comment">// æ–‡ä»¶ç±»å‹: CSV/LOG/CONFIG/OTHER</span>
    upload_status_t status;         <span class="comment">// çŠ¶æ€: PENDING/UPLOADING/SUCCESS/FAILED/CANCELLED</span>
    uint8_t retry_count;            <span class="comment">// é‡è¯•æ¬¡æ•° (æœ€å¤§3æ¬¡)</span>
    uint32_t progress;              <span class="comment">// ä¸Šä¼ è¿›åº¦ (0-100)</span>
    uint32_t uploaded_bytes;        <span class="comment">// å·²ä¸Šä¼ å­—èŠ‚æ•°</span>
    uint32_t data_points;           <span class="comment">// æ•°æ®ç‚¹æ•°é‡ (CSVæ–‡ä»¶)</span>
    time_t create_time;             <span class="comment">// ä»»åŠ¡åˆ›å»ºæ—¶é—´</span>
    time_t complete_time;           <span class="comment">// ä»»åŠ¡å®Œæˆæ—¶é—´</span>
    <span class="keyword">char</span> error_msg[32];             <span class="comment">// é”™è¯¯ä¿¡æ¯</span>
} upload_task_t;

<span class="comment">// æ”¯æŒçš„æ–‡ä»¶æ ¼å¼</span>
<span class="comment">// OneNETæ”¯æŒ: .jpg .jpeg .png .bmp .gif .webp .tiff .txt .csv</span>
            </div>
        </div>
        
        <!-- APIæ¥å£æ±‡æ€» -->
        <div class="section">
            <div class="section-title">
                <div class="icon">8</div>
                OneNet HTTP APIæ¥å£æ±‡æ€»
            </div>
            
            <table class="info-table">
                <tr>
                    <th>åŠŸèƒ½</th>
                    <th>APIç«¯ç‚¹</th>
                    <th>æ–¹æ³•</th>
                    <th>è®¤è¯æ–¹å¼</th>
                    <th>è¯´æ˜</th>
                </tr>
                <tr>
                    <td>è®¾å¤‡æ³¨å†Œ</td>
                    <td><code>iot-api.heclouds.com/device/create</code></td>
                    <td>POST</td>
                    <td>äº§å“çº§Token</td>
                    <td>åˆ›å»ºæ–°è®¾å¤‡ï¼Œè¿”å›didå’Œsec_key</td>
                </tr>
                <tr>
                    <td>è®¾å¤‡ä¸Šä¸‹çº¿</td>
                    <td><code>open.iot.10086.cn/fuse/http/device/online</code></td>
                    <td>POST</td>
                    <td>è®¾å¤‡çº§Token</td>
                    <td>è®¾ç½®è®¾å¤‡åœ¨çº¿/ç¦»çº¿çŠ¶æ€</td>
                </tr>
                <tr>
                    <td>å±æ€§ä¸ŠæŠ¥</td>
                    <td><code>open.iot.10086.cn/fuse/http/device/thing/property/post</code></td>
                    <td>POST</td>
                    <td>è®¾å¤‡çº§Token</td>
                    <td>ä¸ŠæŠ¥ç‰©æ¨¡å‹å±æ€§æ•°æ®</td>
                </tr>
                <tr>
                    <td>äº‹ä»¶ä¸ŠæŠ¥</td>
                    <td><code>open.iot.10086.cn/fuse/http/device/thing/event/post</code></td>
                    <td>POST</td>
                    <td>è®¾å¤‡çº§Token</td>
                    <td>ä¸ŠæŠ¥è®¾å¤‡äº‹ä»¶</td>
                </tr>
                <tr>
                    <td>æ‰¹é‡ä¸ŠæŠ¥</td>
                    <td><code>open.iot.10086.cn/fuse/http/device/thing/pack/post</code></td>
                    <td>POST</td>
                    <td>è®¾å¤‡çº§Token</td>
                    <td>æ‰¹é‡ä¸ŠæŠ¥å¤šä¸ªæ•°æ®ç‚¹</td>
                </tr>
                <tr>
                    <td>å†å²æ•°æ®</td>
                    <td><code>open.iot.10086.cn/fuse/http/device/thing/history/post</code></td>
                    <td>POST</td>
                    <td>è®¾å¤‡çº§Token</td>
                    <td>ä¸ŠæŠ¥å†å²æ•°æ®</td>
                </tr>
                <tr>
                    <td>WiFiå®šä½</td>
                    <td><code>open.iot.10086.cn/fuse-lbs/latest-wifi-location</code></td>
                    <td>GET</td>
                    <td>è®¾å¤‡çº§Token</td>
                    <td>è·å–WiFiå®šä½ç»“æœ</td>
                </tr>
            </table>
            
            <h4 style="margin: 25px 0 15px; color: #333;">HTTPè¯·æ±‚å¤´é…ç½®</h4>
            <div class="code-block">
<span class="comment">// é€šç”¨è¯·æ±‚å¤´</span>
Content-Type: application/json
token: version=2018-10-31&res=products%2F{pid}%2Fdevices%2F{name}&et={expire}&method=sha256&sign={signature}

<span class="comment">// å±æ€§ä¸ŠæŠ¥URLå‚æ•°</span>
?topic=$sys%2F{pid}%2F{device_name}%2Fthing%2Fproperty%2Fpost&protocol=HTTP
            </div>
        </div>
        
        <!-- è®¾è®¡ä¼˜åŠ¿å¯¹æ¯” -->
        <div class="section">
            <div class="section-title">
                <div class="icon">9</div>
                HTTP vs MQTT æ–¹æ¡ˆå¯¹æ¯”
            </div>
            
            <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px;">
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; padding: 20px; border-radius: 12px 12px 0 0;">
                        <h4 style="margin: 0;">ğŸ“¡ HTTPæ–¹æ¡ˆ (æœ¬è®¾è®¡é‡‡ç”¨)</h4>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 0 0 12px 12px; border: 1px solid #e9ecef;">
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            <li style="padding: 8px 0; border-bottom: 1px solid #eee;">âœ… çŸ­è¿æ¥ï¼ŒæŒ‰éœ€è¯·æ±‚</li>
                            <li style="padding: 8px 0; border-bottom: 1px solid #eee;">âœ… èµ„æºæ¶ˆè€—ä½ï¼ˆæ— éœ€ç»´æŠ¤é•¿è¿æ¥ï¼‰</li>
                            <li style="padding: 8px 0; border-bottom: 1px solid #eee;">âœ… å®ç°ç®€å•ï¼ˆæ ‡å‡†HTTPåº“ï¼‰</li>
                            <li style="padding: 8px 0; border-bottom: 1px solid #eee;">âœ… åŸç”Ÿæ”¯æŒæ–‡ä»¶ä¼ è¾“</li>
                            <li style="padding: 8px 0; border-bottom: 1px solid #eee;">âœ… é˜²ç«å¢™å‹å¥½ï¼ˆ80/443ç«¯å£ï¼‰</li>
                            <li style="padding: 8px 0;">âœ… é€‚åˆä½é¢‘ä¸ŠæŠ¥åœºæ™¯</li>
                        </ul>
                    </div>
                </div>
                
                <div style="flex: 1; min-width: 300px;">
                    <div style="background: linear-gradient(135deg, #11998e, #38ef7d); color: #fff; padding: 20px; border-radius: 12px 12px 0 0;">
                        <h4 style="margin: 0;">ğŸ“¨ MQTTæ–¹æ¡ˆ</h4>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 0 0 12px 12px; border: 1px solid #e9ecef;">
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            <li style="padding: 8px 0; border-bottom: 1px solid #eee;">âš ï¸ é•¿è¿æ¥ï¼ŒæŒç»­ä¿æŒ</li>
                            <li style="padding: 8px 0; border-bottom: 1px solid #eee;">âš ï¸ èµ„æºæ¶ˆè€—è¾ƒé«˜ï¼ˆå¿ƒè·³ç»´æŠ¤ï¼‰</li>
                            <li style="padding: 8px 0; border-bottom: 1px solid #eee;">âš ï¸ éœ€è¦MQTTå®¢æˆ·ç«¯åº“</li>
                            <li style="padding: 8px 0; border-bottom: 1px solid #eee;">âš ï¸ æ–‡ä»¶ä¼ è¾“éœ€é¢å¤–å¤„ç†</li>
                            <li style="padding: 8px 0; border-bottom: 1px solid #eee;">âš ï¸ 1883ç«¯å£å¯èƒ½å—é™</li>
                            <li style="padding: 8px 0;">âœ… é€‚åˆé«˜é¢‘å®æ—¶é€šä¿¡</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: 12px; border-left: 4px solid #4caf50;">
                <h4 style="margin: 0 0 10px; color: #2e7d32;">ğŸ’¡ è®¾è®¡é€‰æ‹©ç†ç”±</h4>
                <p style="margin: 0; color: #333; line-height: 1.8;">
                    æœ¬é¡¹ç›®ä½œä¸ºè°ƒè¯•å·¥å…·ï¼Œæ•°æ®ä¸ŠæŠ¥é¢‘ç‡ç›¸å¯¹è¾ƒä½ï¼ˆåˆ†é’Ÿçº§ï¼‰ï¼Œä¸”éœ€è¦æ”¯æŒæµ‹è¯•æ•°æ®æ–‡ä»¶çš„ä¸Šä¼ å­˜å‚¨åŠŸèƒ½ã€‚
                    HTTPæ–¹æ¡ˆä¸ä»…æ»¡è¶³åŠŸèƒ½éœ€æ±‚ï¼Œè¿˜å…·æœ‰å®ç°ç®€å•ã€èµ„æºå ç”¨ä½çš„ä¼˜åŠ¿ã€‚
                    åŒæ—¶ï¼ŒåŸºäºHTTPçš„è‡ªåŠ¨æ³¨å†Œæœºåˆ¶æå¤§ç®€åŒ–äº†è®¾å¤‡éƒ¨ç½²æµç¨‹ï¼Œç”¨æˆ·æ— éœ€æ‰‹åŠ¨é…ç½®å³å¯å®Œæˆè®¾å¤‡æ¿€æ´»ã€‚
                </p>
            </div>
        </div>
        
        <!-- é¡µè„š -->
        <div style="text-align: center; color: rgba(255,255,255,0.8); padding: 20px; font-size: 13px;">
            <p>ESP32-P4 ExDebugTool - OneNetäº‘å¹³å°HTTP APIé›†æˆæŠ€æœ¯æ–‡æ¡£</p>
            <p>Generated: 2025-01</p>
        </div>
    </div>
</body>
</html>
